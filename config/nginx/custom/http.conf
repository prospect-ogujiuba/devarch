# NGINX PROXY MANAGER ADMIN
server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name nginx.mxcro.com npm.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        proxy_pass http://nginx-proxy-manager:81;
        include /data/nginx/custom/server_proxy.conf;
    }

    location /api {
        proxy_pass http://nginx-proxy-manager:81/api;
        include /data/nginx/custom/server_proxy.conf;
    }

    error_log /var/log/nginx/nginx-admin.error.log;
    access_log /var/log/nginx/nginx-admin.access.log;
}

# DATABASE MANAGEMENT TOOLS
server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name metabase.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        set $upstream_metabase metabase:3000;
        proxy_pass http://$upstream_metabase;
        include /data/nginx/custom/server_proxy.conf;
        error_page 502 503 504 = @fallback_metabase;
    }
    
    location @fallback_metabase {
        return 503 "Metabase service is temporarily unavailable";
        add_header Content-Type text/plain always;
    }

    error_log /var/log/nginx/metabase.error.log;
    access_log /var/log/nginx/metabase.access.log;
}

server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name nocodb.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        set $upstream_nocodb nocodb:8080;
        proxy_pass http://$upstream_nocodb;
        include /data/nginx/custom/server_proxy.conf;
        error_page 502 503 504 = @fallback_nocodb;
    }
    
    location @fallback_nocodb {
        return 503 "NocoDB service is temporarily unavailable";
        add_header Content-Type text/plain always;
    }

    error_log /var/log/nginx/nocodb.error.log;
    access_log /var/log/nginx/nocodb.access.log;
}

# ANALYTICS & MONITORING
server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name grafana.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        set $upstream_grafana grafana:3000;
        proxy_pass http://$upstream_grafana;
        include /data/nginx/custom/server_proxy.conf;
        error_page 502 503 504 = @fallback_grafana;
    }
    
    location @fallback_grafana {
        return 503 "Grafana service is temporarily unavailable";
        add_header Content-Type text/plain always;
    }

    error_log /var/log/nginx/grafana.error.log;
    access_log /var/log/nginx/grafana.access.log;
}

server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name prometheus.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        set $upstream_prometheus prometheus:9090;
        proxy_pass http://$upstream_prometheus;
        include /data/nginx/custom/server_proxy.conf;
        error_page 502 503 504 = @fallback_prometheus;
    }
    
    location @fallback_prometheus {
        return 503 "Prometheus service is temporarily unavailable";
        add_header Content-Type text/plain always;
    }

    error_log /var/log/nginx/prometheus.error.log;
    access_log /var/log/nginx/prometheus.access.log;
}

server {
    listen 80;
    http2 on;
    listen 443 ssl;
    server_name matomo.mxcro.com;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    location / {
        set $upstream_matomo matomo:80;
        proxy_pass http://$upstream_matomo;
        include /data/nginx/custom/server_proxy.conf;
        error_page 502 503 504 = @fallback_matomo;
    }
    
    location @fallback_matomo {
        return 503 "Matomo service is temporarily unavailable";
        add_header Content-Type text/plain always;
    }

    error_log /var/log/nginx/matomo.error.log;
    access_log /var/log/nginx/matomo.access.log;
}

# DEVELOPMENT PROJECTS (nested subdomains) - UNIFIED APPROACH
server {
    listen 80 default_server;
    http2 on;
    listen 443 ssl default_server;
    server_name ~^(?<appname>[^.]+)\.mxcro\.com$;

    ssl_certificate /etc/ssl/certs/local.crt;
    ssl_certificate_key /etc/ssl/private/local.key;

    if ($scheme != "https" ) {
        return 301 https://$host$request_uri;
    }

    # Check if this is a known infrastructure service first
    # If it matches any of the specific server blocks above, those take precedence
    
    # For development projects, serve from apps directory
    root /var/www/html/$appname/public;
    index index.php index.html index.htm;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # Direct PHP connection - no upstream needed
        set $upstream_php php:9000;
        fastcgi_pass $upstream_php;
        
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTPS on;
        
        # Handle PHP service being down
        error_page 502 503 504 = @fallback_php;
    }
    
    location @fallback_php {
        return 503 "PHP service is temporarily unavailable. Please start the PHP container.";
        add_header Content-Type text/plain always;
    }

    location ~ /\. {
        deny all;
    }

    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    location ~* wp-config.php$ {
        deny all;
    }

    error_log /var/log/nginx/$appname.error.log;
    access_log /var/log/nginx/$appname.access.log;
}
