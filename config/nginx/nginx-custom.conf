# =================================================================
# DEVARCH NGINX CUSTOM CONFIGURATION
# =================================================================
# This file is loaded by Nginx Proxy Manager to provide custom
# routing for DevArch applications and development tools.

# Global rate limiting zones
limit_req_zone $binary_remote_addr zone=devarch_global:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=devarch_api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=devarch_tools:10m rate=5r/s;

# Log format for DevArch applications
log_format devarch_access '$remote_addr - $remote_user [$time_local] '
                         '"$request" $status $body_bytes_sent '
                         '"$http_referer" "$http_user_agent" '
                         'app="$app_name" rt=$request_time '
                         'uct="$upstream_connect_time" '
                         'uht="$upstream_header_time" '
                         'urt="$upstream_response_time"';

# Security headers map
map $scheme $hsts_header {
    https "max-age=31536000; includeSubDomains; preload";
}

# App name extraction from host
map $host $app_name {
    ~^(?<name>[^.]+)\.test$ $name;
    default "unknown";
}

# Upstream for PHP applications
upstream devarch_php {
    server php-runtime:9000;
    keepalive 16;
}

# Upstream for Node.js applications
upstream devarch_nodejs {
    server php-runtime:3000;
    keepalive 8;
}

# Upstream for Python/Django applications
upstream devarch_python {
    server php-runtime:8000;
    keepalive 8;
}

# Development tools upstreams
upstream devarch_mailpit {
    server mailpit:8025;
    keepalive 4;
}

upstream devarch_adminer {
    server adminer:8080;
    keepalive 4;
}

upstream devarch_phpmyadmin {
    server phpmyadmin:80;
    keepalive 4;
}

upstream devarch_metabase {
    server metabase:3000;
    keepalive 4;
}

upstream devarch_redis_commander {
    server redis-commander:8081;
    keepalive 4;
}

upstream devarch_swagger {
    server swagger-ui:8080;
    keepalive 4;
}

# =================================================================
# CACHE CONFIGURATION
# =================================================================
# Static file caching
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff";
    access_log off;
    
    # Try to serve from apps directory
    try_files $uri $uri/ =404;
}

# API response caching (short-term for development)
location ~* ^/api/ {
    add_header X-Cache-Status $upstream_cache_status;
    expires 5m;
    
    # Rate limiting for API endpoints
    limit_req zone=devarch_api burst=50 nodelay;
}

# =================================================================
# SECURITY CONFIGURATION
# =================================================================
# Security headers (applied globally)
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Strict-Transport-Security $hsts_header always;

# Development-friendly CSP (adjust for production)
add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: ws: wss:; img-src 'self' data: https:; font-src 'self' data: https:;" always;

# Deny access to sensitive files
location ~ /\.(env|git|svn|htaccess|htpasswd)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Deny access to backup files
location ~* \.(bak|backup|old|orig|save|swo|swp|tmp|~)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# =================================================================
# DEVELOPMENT TOOLS ROUTING
# =================================================================
# These location blocks handle development tool routing

# Mailpit email testing
location /mailpit/ {
    proxy_pass http://devarch_mailpit/;
    include /data/nginx/custom/proxy-common.conf;
}

# Database administration
location /adminer/ {
    proxy_pass http://devarch_adminer/;
    include /data/nginx/custom/proxy-common.conf;
}

location /phpmyadmin/ {
    proxy_pass http://devarch_phpmyadmin/;
    include /data/nginx/custom/proxy-common.conf;
}

# Business intelligence
location /metabase/ {
    proxy_pass http://devarch_metabase/;
    include /data/nginx/custom/proxy-common.conf;
}

# Redis management
location /redis/ {
    proxy_pass http://devarch_redis_commander/;
    include /data/nginx/custom/proxy-common.conf;
}

# API documentation
location /swagger/ {
    proxy_pass http://devarch_swagger/;
    include /data/nginx/custom/proxy-common.conf;
}

# =================================================================
# APPLICATION FRAMEWORK DETECTION
# =================================================================
# These location blocks provide framework-specific routing

# Laravel/PHP framework handling
location ~ \.php$ {
    try_files $uri =404;
    
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass devarch_php;
    fastcgi_index index.php;
    
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param HTTPS on;
    fastcgi_param SERVER_NAME $server_name;
    fastcgi_param HTTP_HOST $host;
    
    # Timeouts
    fastcgi_connect_timeout 60s;
    fastcgi_send_timeout 60s;
    fastcgi_read_timeout 60s;
    
    # Rate limiting
    limit_req zone=devarch_global burst=20 nodelay;
}

# WebSocket support for development servers
location /ws {
    proxy_pass http://devarch_nodejs;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Socket.IO support
location /socket.io/ {
    proxy_pass http://devarch_nodejs;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# =================================================================
# LOGGING CONFIGURATION
# =================================================================
# Access logs with app-specific naming
access_log /data/logs/devarch-access.log devarch_access;
error_log /data/logs/devarch-error.log warn;