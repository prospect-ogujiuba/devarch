# =================================================================
# DEVARCH NGINX CONFIGURATION
# =================================================================
# This configuration provides dynamic routing for applications in
# the ./apps folder, accessible via [folderName].test domains

# Global upstream definitions
upstream php-fpm {
    server php-runtime:9000;
    keepalive 16;
}

upstream mailpit-web {
    server mailpit:8025;
    keepalive 8;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# =================================================================
# SSL CONFIGURATION
# =================================================================
# Modern SSL/TLS configuration for security
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
ssl_prefer_server_ciphers off;
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_session_tickets off;

# OCSP stapling
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# =================================================================
# SECURITY HEADERS
# =================================================================
# Security headers applied to all responses
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Development-specific security (adjust for production)
add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src 'self' ws: wss:;" always;

# =================================================================
# GZIP COMPRESSION
# =================================================================
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/svg+xml
    text/css
    text/javascript
    text/plain
    text/xml;

# =================================================================
# MAILPIT WEB INTERFACE
# =================================================================
server {
    listen 80;
    listen 443 ssl http2;
    server_name mailpit.test;

    # SSL certificate paths (will be generated by setup script)
    ssl_certificate /etc/letsencrypt/live/wildcard.test/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wildcard.test/privkey.pem;

    # Force HTTPS
    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }

    # Security headers for mail interface
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        proxy_pass http://mailpit-web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Logging
    access_log /var/log/nginx/mailpit.access.log;
    error_log /var/log/nginx/mailpit.error.log;
}

# =================================================================
# DYNAMIC APPLICATION ROUTING
# =================================================================
# This server block handles all *.test domains and routes them
# to the appropriate application in the ./apps folder
server {
    listen 80 default_server;
    listen 443 ssl http2 default_server;
    server_name ~^(?<app_name>[^.]+)\.test$;

    # SSL certificate paths (wildcard certificate)
    ssl_certificate /etc/letsencrypt/live/wildcard.test/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wildcard.test/privkey.pem;

    # Force HTTPS for all applications
    if ($scheme != "https") {
        return 301 https://$host$request_uri;
    }

    # Security headers for applications
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Set document root based on app name
    set $app_root /var/www/html/$app_name;
    
    # Try different common public folder structures
    set $public_folder "";
    if (-d $app_root/public) {
        set $public_folder "/public";
    }
    if (-d $app_root/web) {
        set $public_folder "/web";
    }
    if (-d $app_root/htdocs) {
        set $public_folder "/htdocs";
    }
    if (-d $app_root/www) {
        set $public_folder "/www";
    }
    
    root $app_root$public_folder;
    index index.php index.html index.htm;

    # Client settings
    client_max_body_size 64M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Rate limiting
    limit_req zone=general burst=20 nodelay;

    # =================================================================
    # STATIC FILE HANDLING
    # =================================================================
    # Handle static assets with long cache times
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        
        # Try to serve static files directly
        try_files $uri $uri/ =404;
        
        # Gzip static files
        gzip_static on;
    }

    # =================================================================
    # PHP APPLICATION HANDLING
    # =================================================================
    # Handle PHP files
    location ~ \.php$ {
        # Security check - ensure file exists
        try_files $uri =404;
        
        # Split path info for PHP frameworks
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # FastCGI settings
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        # Standard FastCGI parameters
        include fastcgi_params;
        
        # Additional parameters for development
        fastcgi_param HTTPS on;
        fastcgi_param APP_ENV local;
        fastcgi_param APP_DEBUG true;
        fastcgi_param SERVER_NAME $server_name;
        
        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;
        
        # Buffer settings
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
    }

    # =================================================================
    # SPA AND API ROUTING
    # =================================================================
    # Handle API routes with higher rate limits
    location ~ ^/api/ {
        limit_req zone=api burst=50 nodelay;
        
        # Try PHP first, then pass to application
        try_files $uri $uri/ @app_fallback;
    }

    # Handle WebSocket connections (for dev servers)
    location ~ ^/(ws|socket\.io|sockjs) {
        proxy_pass http://php-runtime:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =================================================================
    # FRAMEWORK-SPECIFIC ROUTING
    # =================================================================
    # Main location block with framework detection
    location / {
        # Try files in order, then framework-specific fallbacks
        try_files $uri $uri/ @app_fallback;
    }

    # Application fallback for different frameworks
    location @app_fallback {
        # Laravel/Symfony style routing
        if (-f $app_root/public/index.php) {
            rewrite ^(.*)$ /index.php?$query_string last;
        }
        
        # WordPress style routing
        if (-f $app_root/index.php) {
            rewrite ^(.*)$ /index.php$1 last;
        }
        
        # Django/Flask development server proxy
        if (-f $app_root/manage.py) {
            proxy_pass http://php-runtime:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Next.js/Node.js development server proxy
        if (-f $app_root/package.json) {
            proxy_pass http://php-runtime:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Default to 404 if no framework detected
        return 404;
    }

    # =================================================================
    # SECURITY RESTRICTIONS
    # =================================================================
    # Deny access to hidden files and directories
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to sensitive files
    location ~* \.(env|git|svn|htaccess|htpasswd|ini|log|config)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to common backup and temporary files
    location ~* \.(bak|backup|old|orig|save|swo|swp|tmp|~)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to version control directories
    location ~ /\.(git|svn|hg|bzr) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # =================================================================
    # LOGGING
    # =================================================================
    # Dynamic logging based on app name
    access_log /var/log/nginx/$app_name.access.log;
    error_log /var/log/nginx/$app_name.error.log;
}

# =================================================================
# FALLBACK SERVER
# =================================================================
# Catch-all server for requests that don't match any specific domain
server {
    listen 80;
    listen 443 ssl http2;
    server_name _;

    # SSL certificate for fallback
    ssl_certificate /etc/letsencrypt/live/wildcard.test/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wildcard.test/privkey.pem;

    # Return helpful error page
    location / {
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>DevArch - Application Not Found</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; }
        .container { max-width: 600px; margin: 0 auto; }
        .error { color: #d32f2f; }
        .info { color: #1976d2; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DevArch Development Environment</h1>
        <p class="error">Application not found for domain: <strong>$host</strong></p>
        <p class="info">To add a new application:</p>
        <ol>
            <li>Create a folder in <code>./apps/your-app-name/</code></li>
            <li>Add your application files</li>
            <li>Access via <code>https://your-app-name.test</code></li>
        </ol>
        <p>Supported frameworks: Laravel, WordPress, Next.js, Django, and more!</p>
        <p><a href="https://mailpit.test">ðŸ“§ Mailpit (Email Testing)</a></p>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }
}