global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  # Prometheus itself
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # Grafana
  - job_name: "grafana"
    static_configs:
      - targets: ["grafana:3000"]

  # Backend application services (using container names and internal ports)
  - job_name: 'microservices-backend'
    static_configs:
      - targets:
          - 'php:8000'       # PHP service
    scrape_interval: 15s
    metrics_path: '/metrics'
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        regex: 'php:.*'
        target_label: service
        replacement: 'php-backend'

  # Database services (internal container access)
  - job_name: 'database-services'
    static_configs:
      - targets:
          - 'mariadb:3306'
          - 'mysql:3306'
          - 'postgres:5432'
          - 'mongodb:27017'
          - 'redis:6379'
    scrape_interval: 30s
    metrics_path: '/metrics'
    scrape_timeout: 15s
    relabel_configs:
      - source_labels: [__address__]
        regex: 'mariadb:.*'
        target_label: service
        replacement: 'mariadb'
      - source_labels: [__address__]
        regex: 'mysql:.*'
        target_label: service
        replacement: 'mysql'
      - source_labels: [__address__]
        regex: 'postgres:.*'
        target_label: service
        replacement: 'postgres'
      - source_labels: [__address__]
        regex: 'mongodb:.*'
        target_label: service
        replacement: 'mongodb'
      - source_labels: [__address__]
        regex: 'redis:.*'
        target_label: service
        replacement: 'redis'
      - target_label: service_type
        replacement: 'database'

  # Analytics and observability stack (using container names)
  - job_name: 'analytics-stack'
    static_configs:
      - targets:
          - 'grafana:3000'
          - 'matomo:80'
    scrape_interval: 30s
    metrics_path: '/metrics'
    scrape_timeout: 10s
    relabel_configs:
      - source_labels: [__address__]
        regex: 'grafana:.*'
        target_label: service
        replacement: 'grafana'
      - source_labels: [__address__]
        regex: 'matomo:.*'
        target_label: service
        replacement: 'matomo'
      - target_label: service_type
        replacement: 'analytics'

  # Database management tools (using container names and internal ports)
  - job_name: 'db-management-tools'
    static_configs:
          - 'metabase:3000'
          - 'nocodb:8080'
    scrape_interval: 60s
    metrics_path: '/metrics'
    scrape_timeout: 10s
    honor_labels: false
    relabel_configs:
      - source_labels: [__address__]
        regex: 'metabase:.*'
        target_label: service
        replacement: 'metabase'
      - source_labels: [__address__]
        regex: 'nocodb:.*'
        target_label: service
        replacement: 'nocodb'
      - target_label: service_type
        replacement: 'db-tools'