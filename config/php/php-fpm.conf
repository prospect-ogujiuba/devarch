# =================================================================
# DEVARCH PHP-FPM CONFIGURATION
# =================================================================
# Optimized PHP-FPM configuration for development environment
# with performance tuning and development-friendly settings.

# =================================================================
# GLOBAL CONFIGURATION
# =================================================================
[global]
; Pid file
pid = /run/php/php-fpm.pid

; Error log file
error_log = /var/log/php/php-fpm.log

; Log level for global error_log
log_level = notice

; Send FPM to background (default: yes)
daemonize = no

; Set open file descriptor rlimit for master process
rlimit_files = 65536

; Set max core size rlimit for master process
rlimit_core = 0

; Specify the event mechanism FPM will use
events.mechanism = epoll

; When FPM is built with systemd integration, specify the interval,
; in seconds, between health report notification to systemd
systemd_interval = 10

; =================================================================
# POOL CONFIGURATION - WWW
# =================================================================
[www]
; The address on which to accept FastCGI requests
listen = 0.0.0.0:9000

; Set listen(2) backlog
listen.backlog = 511

; Set permissions for unix socket
;listen.owner = www-data
;listen.group = www-data
;listen.mode = 0660

; List of addresses (IPv4/IPv6) of FastCGI clients
listen.allowed_clients = any

; Unix user/group of processes
user = www-data
group = www-data

; The number of child processes to be created when pm is set to 'static'
; This value sets the limit on the number of simultaneous requests
; For development environment with moderate load
pm = dynamic

; Maximum number of child processes
pm.max_children = 50

; The number of child processes created on startup
pm.start_servers = 5

; The desired minimum number of idle server processes
pm.min_spare_servers = 5

; The desired maximum number of idle server processes
pm.max_spare_servers = 15

; The number of requests each child process should execute before respawning
; Useful to work around memory leaks in 3rd party libraries
pm.max_requests = 1000

; The URI to view the FPM status page
pm.status_path = /status

; The ping URI to call the monitoring page of FPM
ping.path = /ping

; This directive may be used to customize the response of a ping request
ping.response = pong

; =================================================================
# PROCESS MANAGEMENT
# =================================================================
; The timeout for serving a single request
request_terminate_timeout = 300

; The timeout set by 'request_terminate_timeout' ini option
request_slowlog_timeout = 30

; The log file for slow requests
slowlog = /var/log/php/php-fpm-slow.log

; Set to 'yes' to terminate timeout set by 'request_terminate_timeout'
request_terminate_timeout_track_finished = no

; =================================================================
# LOGGING CONFIGURATION
# =================================================================
; Access log file
access.log = /var/log/php/php-fpm-access.log

; Access log format
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; The log file for wrapper stdout
catch_workers_output = yes

; If catch_workers_output is enabled, clear environment in FPM workers
clear_env = no

; =================================================================
# SECURITY SETTINGS
# =================================================================
; Limits the extensions of the main script FPM will allow to parse
security.limit_extensions = .php .phar

; =================================================================
# ENVIRONMENT VARIABLES
# =================================================================
; Additional environment variables for development
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; Development environment variables
env[APP_ENV] = local
env[APP_DEBUG] = true
env[LOG_CHANNEL] = daily

; Database environment variables
env[DB_CONNECTION] = mysql
env[DB_HOST] = mariadb
env[DB_PORT] = 3306
env[DB_DATABASE] = devarch
env[DB_USERNAME] = devarch_user
env[DB_PASSWORD] = 123456

; Redis environment variables
env[REDIS_HOST] = redis
env[REDIS_PASSWORD] = 123456
env[REDIS_PORT] = 6379

; Mail environment variables
env[MAIL_MAILER] = smtp
env[MAIL_HOST] = mailpit
env[MAIL_PORT] = 1025
env[MAIL_FROM_ADDRESS] = noreply@devarch.test

; =================================================================
# PHP ADMIN VALUES
# =================================================================
; PHP configuration that cannot be overridden by user scripts

; Security settings
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,parse_ini_file,show_source
php_admin_flag[allow_url_fopen] = on
php_admin_flag[allow_url_include] = off

; Error handling
php_admin_value[error_log] = /var/log/php/php-errors.log
php_admin_flag[log_errors] = on
php_admin_flag[display_errors] = on
php_admin_flag[display_startup_errors] = on

; Resource limits
php_admin_value[memory_limit] = 512M
php_admin_value[max_execution_time] = 300
php_admin_value[max_input_time] = 300
php_admin_value[post_max_size] = 64M
php_admin_value[upload_max_filesize] = 64M

; Session configuration
php_admin_value[session.save_path] = /tmp
php_admin_value[session.name] = DEVSESSID
php_admin_flag[session.cookie_secure] = on
php_admin_flag[session.cookie_httponly] = on
php_admin_value[session.cookie_samesite] = "Lax"

; =================================================================
# PHP VALUES
# =================================================================
; PHP configuration that can be overridden by user scripts

; Timezone
php_value[date.timezone] = America/Toronto

; Character encoding
php_value[default_charset] = UTF-8
php_value[mbstring.internal_encoding] = UTF-8

; Opcache settings
php_value[opcache.enable] = 1
php_value[opcache.memory_consumption] = 256
php_value[opcache.max_accelerated_files] = 10000
php_value[opcache.validate_timestamps] = 1
php_value[opcache.revalidate_freq] = 0

; Xdebug settings for development
php_value[xdebug.mode] = develop,debug
php_value[xdebug.start_with_request] = yes
php_value[xdebug.client_host] = host.docker.internal
php_value[xdebug.client_port] = 9003
php_value[xdebug.idekey] = DEVARCH
php_value[xdebug.log] = /var/log/php/xdebug.log

; =================================================================
# ADDITIONAL POOLS (Optional)
# =================================================================

# You can define additional pools for different applications
# Example pool for high-performance applications
[performance]
listen = 127.0.0.1:9001
user = www-data
group = www-data
pm = static
pm.max_children = 20
pm.max_requests = 500
request_terminate_timeout = 60
php_admin_value[memory_limit] = 256M

# Example pool for CLI/long-running tasks
[cli]
listen = 127.0.0.1:9002
user = www-data
group = www-data
pm = ondemand
pm.max_children = 10
pm.process_idle_timeout = 60s
pm.max_requests = 100
request_terminate_timeout = 0
php_admin_value[memory_limit] = 1G
php_admin_value[max_execution_time] = 0

# =================================================================
# DEVELOPMENT NOTES
# =================================================================
; This configuration is optimized for development environments.
; For production use, consider:
; 1. Reducing pm.max_children based on available memory
; 2. Disabling xdebug
; 3. Enabling opcache with longer revalidation frequency
; 4. Setting more restrictive disable_functions
; 5. Enabling additional security measures
; 6. Tuning process management based on load patterns