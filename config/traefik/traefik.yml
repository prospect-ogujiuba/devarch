# Traefik Configuration - Updated for NPM Integration
global:
  checkNewVersion: false
  sendAnonymousUsage: false

log:
  level: INFO

accesslog: {}

# OpenTelemetry tracing configuration pointing to collector
tracing:
  serviceName: traefik
  sampleRate: 1.0
  otlp:
    http:
      endpoint: http://otel-collector:4318/v1/traces
      headers:
        content-type: application/json

api:
  dashboard: true
  insecure: false

entryPoints:
  web:
    address: :80
    http:
      redirections:
        entrypoint:
          to: websecure
          scheme: https
  websecure:
    address: :443

serversTransport:
  insecureSkipVerify: true

# TLS Configuration with local certificates
tls:
  certificates:
    - certFile: /var/traefik/certs/local.crt
      keyFile: /var/traefik/certs/local.key
      stores:
        - default
  stores:
    default:
      defaultCertificate:
        certFile: /var/traefik/certs/local.crt
        keyFile: /var/traefik/certs/local.key
  options:
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"

# Prometheus metrics configuration
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    buckets:
      - 0.1
      - 0.3
      - 1.2
      - 5.0
      - 10.0
      - 30.0
    headerLabels:
      useragent: User-Agent
      host: X-Forwarded-Host

providers:
  file:
    directory: /etc/traefik
    watch: true
  
  docker:
    endpoint: "unix:///var/run/podman/podman.sock"
    network: microservices-net
    exposedByDefault: false
    watch: true

# Static route configuration for NPM integration
http:
  routers:
    # Route ALL *.test domains to NPM (except known services)
    npm-dev-projects:
      rule: "HostRegexp(`{subdomain:[a-zA-Z0-9-]+}\\.test`) && !Host(`traefik.test`, `npm.test`, `grafana.test`, `prometheus.test`, `adminer.test`, `phpmyadmin.test`, `mongodb.test`, `metabase.test`, `nocodb.test`, `pgadmin.test`, `redis.test`, `mailpit.test`, `gitea.test`, `n8n.test`, `langflow.test`, `matomo.test`, `kibana.test`, `elasticsearch.test`, `logstash.test`, `cadvisor.test`, `blackbox.test`, `node-exporter.test`, `postgres-exporter.test`, `redis-exporter.test`, `mysql-exporter.test`, `mongodb-exporter.test`, `otel.test`)"
      entrypoints:
        - websecure
      service: npm-dev-projects
      tls: true
      priority: 1  # Lower priority so specific service routes take precedence

    # NPM Admin Dashboard
    npm-admin:
      rule: "Host(`npm.test`)"
      entrypoints:
        - websecure
      service: npm-admin
      tls: true
      priority: 100

  services:
    # Route development projects to NPM HTTPS port
    npm-dev-projects:
      loadBalancer:
        servers:
          - url: "https://nginx-proxy-manager:443"
        passHostHeader: true
        serversTransport: insecureTransport

    # NPM Admin Dashboard
    npm-admin:
      loadBalancer:
        servers:
          - url: "http://nginx-proxy-manager:81"

  serversTransports:
    insecureTransport:
      insecureSkipVerify: true