# config/traefik/traefik.yml
# Updated configuration with clean domain separation

global:
  checkNewVersion: false
  sendAnonymousUsage: false

log:
  level: INFO

accesslog: {}

# OpenTelemetry tracing configuration
tracing:
  serviceName: traefik
  sampleRate: 1.0
  otlp:
    http:
      endpoint: http://otel-collector:4318/v1/traces
      headers:
        content-type: application/json

api:
  dashboard: true
  insecure: false

entryPoints:
  web:
    address: :80
    http:
      redirections:
        entrypoint:
          to: websecure
          scheme: https
  websecure:
    address: :443

serversTransport:
  insecureSkipVerify: true

# TLS Configuration with local certificates
tls:
  certificates:
    - certFile: /var/traefik/certs/local.crt
      keyFile: /var/traefik/certs/local.key
      stores:
        - default
  stores:
    default:
      defaultCertificate:
        certFile: /var/traefik/certs/local.crt
        keyFile: /var/traefik/certs/local.key
  options:
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"

# Prometheus metrics configuration
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    buckets:
      - 0.1
      - 0.3
      - 1.2
      - 5.0
      - 10.0
      - 30.0
    headerLabels:
      useragent: User-Agent
      host: X-Forwarded-Host

providers:
  file:
    directory: /etc/traefik
    watch: true
  
  docker:
    endpoint: "unix:///var/run/podman/podman.sock"
    network: microservices-net
    exposedByDefault: false
    watch: true

# Static route configuration - CLEAN SEPARATION
http:
  routers:
    # === DEVELOPMENT PROJECTS ROUTING ===
    # Single rule to handle ALL *.dev.test domains â†’ NPM
    npm-dev-projects:
      rule: "HostRegexp(`{subdomain:[a-zA-Z0-9-]+}\\.dev\\.test`)"
      entrypoints:
        - websecure
      service: npm-dev-projects
      tls: true
      priority: 10  # Lower priority so specific service routes take precedence

    # === INFRASTRUCTURE SERVICES ROUTING ===
    # NPM Admin Dashboard
    npm-admin:
      rule: "Host(`nginx.test`)"
      entrypoints:
        - websecure
      service: npm-admin
      tls: true
      priority: 100
 
    # Traefik Dashboard (self-reference)
    traefik-dashboard:
      rule: "Host(`traefik.test`)"
      entrypoints:
        - websecure
      service: api@internal
      tls: true
      priority: 100

  services:
    # === DEVELOPMENT PROJECTS SERVICE ===
    # Route ALL *.dev.test to NPM's main HTTP port
    npm-dev-projects:
      loadBalancer:
        servers:
          - url: "http://nginx-proxy-manager:80"
        passHostHeader: true
        serversTransport: insecureTransport

    # === INFRASTRUCTURE SERVICES ===
    # NPM Admin Dashboard
    npm-admin:
      loadBalancer:
        servers:
          - url: "http://nginx-proxy-manager:81"

  serversTransports:
    insecureTransport:
      insecureSkipVerify: true