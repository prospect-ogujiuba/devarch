version: "3.8"

# =================================================================
# DEVELOPMENT TOOLS AND UTILITIES
# =================================================================
# This compose file defines development tools and utilities for
# database management, debugging, and development workflow.

networks:
  devarch-network:
    external: true

volumes:
  # Database Management Tools
  adminer_data:
    driver: local
  metabase_data:
    driver: local
  
  # Optional MongoDB (if enabled)
  mongodb_data:
    driver: local
  mongodb_dump:
    driver: local

services:
  # =================================================================
  # DATABASE ADMINISTRATION TOOLS
  # =================================================================
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - ADMINER_DEFAULT_SERVER=${ADMINER_DEFAULT_SERVER}
      - ADMINER_DESIGN=${ADMINER_DESIGN}
      - ADMINER_PLUGINS=tables-filter tinymce
    ports:
      - "127.0.0.1:${ADMINER_PORT}:8080"
    volumes:
      - adminer_data:/var/www/html/plugins-enabled
    networks:
      - devarch-network
    depends_on:
      - mariadb
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  phpmyadmin:
    image: phpmyadmin:5.2
    container_name: phpmyadmin
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - PMA_HOST=${PMA_HOST}
      - PMA_PORT=${PMA_PORT}
      - PMA_USER=${PMA_USER}
      - PMA_PASSWORD=${PMA_PASSWORD}
      - PMA_ARBITRARY=1
      - PMA_ABSOLUTE_URI=https://phpmyadmin.test
      - UPLOAD_LIMIT=64M
      - MEMORY_LIMIT=512M
      - MAX_EXECUTION_TIME=300
    ports:
      - "127.0.0.1:${PHPMYADMIN_PORT}:80"
    networks:
      - devarch-network
    depends_on:
      - mariadb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  metabase:
    image: metabase/metabase:v0.48.4
    container_name: metabase
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=metabase
      - MB_DB_PORT=${POSTGRES_PORT}
      - MB_DB_USER=${POSTGRES_USER}
      - MB_DB_PASS=${POSTGRES_PASSWORD}
      - MB_DB_HOST=${POSTGRES_HOST}
      - MB_ENCRYPTION_SECRET_KEY=${JWT_SECRET}
      - JAVA_OPTS=-Xmx1g
    ports:
      - "127.0.0.1:3030:3000"
    volumes:
      - metabase_data:/metabase-data
    networks:
      - devarch-network
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =================================================================
  # MONGODB AND TOOLS (Optional)
  # =================================================================
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGO_INITDB_DATABASE}
    ports:
      - "127.0.0.1:${MONGO_EXTERNAL_PORT}:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_dump:/dump
      - ${CONFIG_PATH}/databases/mongodb:/docker-entrypoint-initdb.d:ro
    networks:
      - devarch-network
    command: >
      mongod 
      --auth 
      --bind_ip_all
      --logpath /var/log/mongodb/mongod.log
      --logappend
      --quiet
    profiles:
      - mongodb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  mongo-express:
    image: mongo-express:1.0.2
    container_name: mongo-express
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - ME_CONFIG_MONGODB_SERVER=${ME_CONFIG_MONGODB_SERVER}
      - ME_CONFIG_MONGODB_PORT=${ME_CONFIG_MONGODB_PORT}
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=${ME_CONFIG_MONGODB_ENABLE_ADMIN}
      - ME_CONFIG_MONGODB_AUTH_DATABASE=${ME_CONFIG_MONGODB_AUTH_DATABASE}
      - ME_CONFIG_MONGODB_AUTH_USERNAME=${ME_CONFIG_MONGODB_AUTH_USERNAME}
      - ME_CONFIG_MONGODB_AUTH_PASSWORD=${ME_CONFIG_MONGODB_AUTH_PASSWORD}
      - ME_CONFIG_BASICAUTH_USERNAME=${ME_CONFIG_BASICAUTH_USERNAME}
      - ME_CONFIG_BASICAUTH_PASSWORD=${ME_CONFIG_BASICAUTH_PASSWORD}
      - ME_CONFIG_SITE_BASEURL=/
      - ME_CONFIG_SITE_COOKIESECRET=${SESSION_SECRET}
      - ME_CONFIG_SITE_SESSIONSECRET=${SESSION_SECRET}
    ports:
      - "127.0.0.1:${MONGO_EXPRESS_PORT}:8081"
    networks:
      - devarch-network
    depends_on:
      - mongodb
    profiles:
      - mongodb
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  # =================================================================
  # DEVELOPMENT UTILITIES
  # =================================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD}
      - HTTP_USER=${ADMIN_USER}
      - HTTP_PASSWORD=${ADMIN_PASSWORD}
      - PORT=8081
    ports:
      - "127.0.0.1:8090:8081"
    networks:
      - devarch-network
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # =================================================================
  # API TESTING AND DOCUMENTATION
  # =================================================================
  swagger-ui:
    image: swaggerapi/swagger-ui:v5.9.0
    container_name: swagger-ui
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - SWAGGER_JSON_URL=https://petstore.swagger.io/v2/swagger.json
      - BASE_URL=/swagger
      - DEEP_LINKING=true
      - DISPLAY_OPERATION_ID=true
      - DEFAULT_MODELS_EXPAND_DEPTH=1
      - DEFAULT_MODEL_EXPAND_DEPTH=1
      - DEFAULT_MODEL_RENDERING=example
      - DISPLAY_REQUEST_DURATION=true
      - DOC_EXPANSION=list
      - FILTER=true
      - MAX_DISPLAYED_TAGS=10
      - SHOW_EXTENSIONS=true
      - SHOW_COMMON_EXTENSIONS=true
      - USE_UNSAFE_INLINE=true
    ports:
      - "127.0.0.1:8091:8080"
    networks:
      - devarch-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =================================================================
  # CODE QUALITY AND TESTING TOOLS
  # =================================================================
  sonarqube:
    image: sonarqube:10.3-community
    container_name: sonarqube
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - SONAR_JDBC_URL=jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/sonarqube
      - SONAR_JDBC_USERNAME=${POSTGRES_USER}
      - SONAR_JDBC_PASSWORD=${POSTGRES_PASSWORD}
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    ports:
      - "127.0.0.1:9000:9000"
    networks:
      - devarch-network
    depends_on:
      - postgres
    profiles:
      - quality
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9000/api/system/status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 90s

  # =================================================================
  # DOCUMENTATION TOOLS
  # =================================================================
  gitiles:
    image: gerritcodereview/gitiles:latest
    container_name: gitiles
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    ports:
      - "127.0.0.1:8092:8080"
    volumes:
      - ${APPS_PATH}:/var/gerrit/git:ro
    networks:
      - devarch-network
    profiles:
      - docs
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # =================================================================
  # REVERSE PROXY FOR DEVELOPMENT TOOLS
  # =================================================================
  # Note: Development tools will be accessible via:
  # - adminer.test (Database administration)
  # - phpmyadmin.test (MySQL/MariaDB management)
  # - metabase.test (Business intelligence)
  # - mongodb.test (MongoDB management - if enabled)
  # - redis.test (Redis management)
  # - swagger.test (API documentation)
  # - sonarqube.test (Code quality - if enabled)
  # - gitiles.test (Git repository browser - if enabled)

# =================================================================
# PROFILES EXPLANATION
# =================================================================
# This compose file uses profiles to optionally enable services:
#
# Start with MongoDB:
#   docker compose --profile mongodb up -d
#
# Start with code quality tools:
#   docker compose --profile quality up -d
#
# Start with documentation tools:
#   docker compose --profile docs up -d
#
# Start all services:
#   docker compose --profile mongodb --profile quality --profile docs up -d
#
# Default services (no profile needed):
#   - adminer
#   - phpmyadmin  
#   - metabase
#   - redis-commander
#   - swagger-ui