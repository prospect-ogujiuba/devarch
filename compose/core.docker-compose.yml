version: "3.8"

# =================================================================
# CORE INFRASTRUCTURE SERVICES
# =================================================================
# This compose file defines the essential services needed for the
# development architecture: web server, databases, and networking.

networks:
  devarch-network:
    driver: bridge
    attachable: true
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  # Database Storage
  mariadb_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local

  # Web Server Storage
  nginx_data:
    driver: local
  nginx_letsencrypt:
    driver: local
  nginx_logs:
    driver: local

  # PHP Runtime Storage
  php_logs:
    driver: local

services:
  # =================================================================
  # REVERSE PROXY & WEB SERVER
  # =================================================================
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      # Database connection for NPM
      - DB_MYSQL_HOST=${NPM_DB_MYSQL_HOST}
      - DB_MYSQL_PORT=${NPM_DB_MYSQL_PORT}
      - DB_MYSQL_USER=${NPM_DB_MYSQL_USER}
      - DB_MYSQL_PASSWORD=${NPM_DB_MYSQL_PASSWORD}
      - DB_MYSQL_NAME=${NPM_DB_MYSQL_NAME}
    ports:
      - "${NGINX_HTTP_PORT}:80"     # HTTP
      - "${NGINX_HTTPS_PORT}:443"   # HTTPS
      - "${NGINX_ADMIN_PORT}:81"    # Admin Interface
    volumes:
      - nginx_data:/data
      - nginx_letsencrypt:/etc/letsencrypt
      - nginx_logs:/var/log/nginx
      - ${APPS_PATH}:/var/www/html:ro
      - ${CONFIG_PATH}/nginx:/data/nginx/custom:ro
    networks:
      - devarch-network
    depends_on:
      - mariadb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =================================================================
  # DATABASE SERVICES
  # =================================================================
  mariadb:
    image: mariadb:11.4
    container_name: mariadb
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MYSQL_DATABASE}
      - MARIADB_USER=${MYSQL_USER}
      - MARIADB_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "127.0.0.1:${MYSQL_EXTERNAL_PORT}:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ${CONFIG_PATH}/databases/mariadb:/etc/mysql/conf.d:ro
    networks:
      - devarch-network
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb-buffer-pool-size=256M
      --max-connections=200
      --thread-cache-size=16
      --query-cache-size=64M
      --query-cache-type=1
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_MULTIPLE_DATABASES=${POSTGRES_MULTIPLE_DATABASES}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=${TZ}
    ports:
      - "127.0.0.1:${POSTGRES_EXTERNAL_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ${CONFIG_PATH}/databases/postgres:/docker-entrypoint-initdb.d:ro
    networks:
      - devarch-network
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    environment:
      - TZ=${TZ}
    ports:
      - "127.0.0.1:${REDIS_EXTERNAL_PORT}:6379"
    volumes:
      - redis_data:/data
      - ${CONFIG_PATH}/databases/redis:/usr/local/etc/redis:ro
    networks:
      - devarch-network
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --timeout 300
      --tcp-keepalive 60
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # =================================================================
  # RUNTIME ENVIRONMENT
  # =================================================================
  php-runtime:
    build:
      context: ${CONFIG_PATH}/php
      dockerfile: Dockerfile
      args:
        - PHP_VERSION=${PHP_VERSION}
        - NODE_VERSION=${NODE_VERSION}
        - PYTHON_VERSION=${PYTHON_VERSION}
    container_name: php-runtime
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT}
      - PHP_MAX_EXECUTION_TIME=${PHP_MAX_EXECUTION_TIME}
      - PHP_UPLOAD_MAX_FILESIZE=${PHP_UPLOAD_MAX_FILESIZE}
      - PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE}
      - XDEBUG_MODE=${XDEBUG_MODE}
      - XDEBUG_CLIENT_HOST=${XDEBUG_CLIENT_HOST}
      # Database connections for applications
      - DB_HOST=${MYSQL_HOST}
      - DB_PORT=${MYSQL_PORT}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_USERNAME=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # Mail configuration
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME}
    ports:
      - "127.0.0.1:${PHP_FPM_PORT}:9000"
      - "127.0.0.1:${VITE_PORT}:5173"    # Vite dev server
      - "127.0.0.1:3001:3000"            # Node.js apps
      - "127.0.0.1:8001:8000"            # Django dev server
    volumes:
      - ${APPS_PATH}:/var/www/html
      - ${CONFIG_PATH}/php/php.ini:/usr/local/etc/php/php.ini:ro
      - ${CONFIG_PATH}/php/php-fpm.conf:/usr/local/etc/php-fpm.conf:ro
      - php_logs:/var/log/php
      - /tmp:/tmp
    networks:
      - devarch-network
    depends_on:
      - mariadb
      - postgres
      - redis
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # =================================================================
  # MAIL DEVELOPMENT SERVICE
  # =================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - MP_MAX_MESSAGES=${MAILPIT_MAX_MESSAGES}
      - MP_DATA_FILE=${MAILPIT_DATA_FILE}
      - MP_SMTP_AUTH_ACCEPT_ANY=${MAILPIT_SMTP_AUTH_ACCEPT_ANY}
      - MP_SMTP_AUTH_ALLOW_INSECURE=${MAILPIT_SMTP_AUTH_ALLOW_INSECURE}
    ports:
      - "127.0.0.1:${MAILPIT_PORT}:8025"    # Web UI
      - "127.0.0.1:${MAILPIT_SMTP_PORT}:1025"  # SMTP
    networks:
      - devarch-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

# =================================================================
# NETWORK CONFIGURATION
# =================================================================
# The devarch-network allows all services to communicate with each other
# using service names as hostnames. External access is controlled via
# port mappings and the nginx proxy manager.