# DevArch: Agent Notes (Read First)

This repo is a microservices dev environment: one compose file per service, managed via `scripts/service-manager.sh`.

No Cursor/Copilot rules found (no `.cursorrules`, no `.cursor/rules/`, no `.github/copilot-instructions.md`).

## Layout / What's "source of truth"

- Compose files: `compose/<category>/<service>.yml` (one service per file)
- Service configs/Dockerfiles: `config/<service>/...`
- Primary CLI: `scripts/service-manager.sh` (zsh)
- Go API: `api/` (Chi router)
- Dashboard: `dashboard/` (Vite + React + TS)

## Build / Lint / Test (fast paths)

### Service manager (containers)

- List services: `./scripts/service-manager.sh list`
- Status: `./scripts/service-manager.sh status` (or `... status <service>`)
- Start/stop one: `./scripts/service-manager.sh up <service>` / `... down <service>`
- Rebuild one: `./scripts/service-manager.sh rebuild <service> [--no-cache]`
- Logs: `./scripts/service-manager.sh logs <service> --follow --tail 200`
- Start category: `./scripts/service-manager.sh start database` (or multiple categories)

Notes:
- Network: `microservices-net` (created automatically)
- Use `--sudo` if your runtime requires it.
- `--remove-volumes` is destructive (deletes persisted data).

### Dashboard (Vite + React)

From `dashboard/`:

- Install: `npm install`
- Dev server: `npm run dev` (Vite on `http://localhost:5174`)
- Build: `npm run build` (or stricter: `npm run build:strict`)
- Lint: `npm run lint`

Running a single test: no JS test runner is configured (no `test` script, no Vitest/Jest config). If adding tests, prefer Vitest and document the exact command here.

### Go API (devarch-api)

Local dev (no containers), from `api/`:

- Build: `go build ./cmd/server`
- Run server:
  - `DATABASE_URL=postgres://postgres:admin1234567@localhost:8502/postgres?sslmode=disable PORT=8081 go run ./cmd/server`
- Migrations:
  - Up: `DATABASE_URL=... go run ./cmd/migrate -cmd up -migrations ./migrations`
  - Down (roll back 1): `DATABASE_URL=... go run ./cmd/migrate -cmd down -migrations ./migrations`
  - Status: `DATABASE_URL=... go run ./cmd/migrate -cmd status -migrations ./migrations`
- Import compose files into DB:
  - `DATABASE_URL=... go run ./cmd/import -compose-dir ../compose`

Container dev (recommended for full-stack), from repo root:

- Start DB + API: `./scripts/service-manager.sh up postgres && ./scripts/service-manager.sh up devarch-api`
- API is exposed on `http://localhost:8550` (container port 8080)

Lint/format/test, from `api/`:

- Format: `gofmt -w .`
- Vet: `go vet ./...`
- Test all: `go test ./...`
- Run a single test:
  - By name: `go test ./... -run '^TestName$' -count=1`
  - By package: `go test ./internal/api -run '^TestName$' -count=1`

## Code Style (repo conventions)

### General

- Don't churn formatting in unrelated lines/files.
- Prefer small, focused diffs; keep existing patterns in the touched area.
- Avoid committing secrets: `.env` and anything credential-like should not be added to git.
- Git hygiene in this repo: don't commit docs (`*.md`) unless explicitly requested.

### Compose / service naming

- Service names: lowercase + hyphen-separated (`service-name`), max ~64 chars.
- Compose files: one service per file, named `<service>.yml`.
- All services join `microservices-net`; use service name as hostname.

### Dashboard (TypeScript/React)

Tooling:

- TypeScript is strict (`dashboard/tsconfig.app.json`); keep `noUnusedLocals`/`noUnusedParameters` green.
- ESLint: `@eslint/js` + `typescript-eslint` + `react-hooks` + `react-refresh` (`dashboard/eslint.config.js`).
- Path alias: import from `@/` instead of deep relatives when it improves clarity.

Imports:

- Group imports in this order: (1) react/3p libs (2) `@/` (3) relative `./`/`../`.
- Don't reorder purely for style unless you already touch the block.

Files/names:

- Components: `PascalCase` component names; file names are typically kebab-case (`service-card.tsx`).
- Hooks: `use-*.ts` (kebab-case file names), exported hook `useXxx`.
- Types: keep shared API shapes in `dashboard/src/types/api.ts`.

Generated code:

- Don't edit `dashboard/src/routeTree.gen.ts` (generated by TanStack Router plugin).

Error handling:

- API calls go through `dashboard/src/lib/api.ts` (axios instance, `X-API-Key` from localStorage).
- Prefer user-facing errors via existing toast/alert patterns (search for `sonner`).

### Go API

Formatting/imports:

- Always `gofmt` before finishing.
- Let `gofmt` manage import grouping; don't hand-align.

HTTP handlers:

- Router is Chi (`api/internal/api/routes.go`). Add endpoints under `/api/v1`.
- Middleware: auth/rate limit lives in `api/internal/api/middleware`.
- Response headers: set `Content-Type` appropriately; JSON uses `application/json`.
- Prefer consistent status codes; use `http.Error` for plain-text error bodies (current pattern).

DB/SQL:

- Use parameterized queries (`$1`, `$2`, ...). Whitelist any dynamic column names (see sort handling in `api/internal/api/handlers/service.go`).
- Close rows (`defer rows.Close()`); check `rows.Err()`.

Errors:

- Wrap internal errors with context when returning upward (`fmt.Errorf("...: %w", err)`) unless the current function already returns plain `err`.
- Don't leak secrets in error messages.

## Useful env vars / ports

- Dashboard dev: `http://localhost:5174`
- Go API (container): `http://localhost:8550` (proxy target in `dashboard/vite.config.ts`)
- API auth: set `DEVARCH_API_KEY` to require `X-API-Key`.

<!-- End of file -->
