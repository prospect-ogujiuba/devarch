---
phase: 02-stack-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/migrations/013_stacks_instances.up.sql
  - api/migrations/013_stacks_instances.down.sql
  - api/internal/api/handlers/stack.go
autonomous: true

must_haves:
  truths:
    - "Stacks table has deleted_at column with partial unique index on name"
    - "Stack handler supports Create, List, Get, Update, Delete (soft)"
    - "Validation uses existing container.ValidateName for prescriptive errors"
    - "Soft delete sets deleted_at instead of removing row"
    - "List excludes soft-deleted stacks by default"
  artifacts:
    - path: "api/migrations/013_stacks_instances.up.sql"
      provides: "Stacks table with soft-delete support"
      contains: "deleted_at"
    - path: "api/internal/api/handlers/stack.go"
      provides: "Stack CRUD handler"
      exports: ["NewStackHandler", "Create", "List", "Get", "Update", "Delete"]
  key_links:
    - from: "api/internal/api/handlers/stack.go"
      to: "api/internal/container/validation.go"
      via: "container.ValidateName()"
      pattern: "container\\.ValidateName"
---

<objective>
Create stack CRUD API handler with soft-delete migration support.

Purpose: Foundation for all stack operations — migration schema and core CRUD handler.
Output: Updated migration 013 with deleted_at + StackHandler with Create/List/Get/Update/Delete.
</objective>

<execution_context>
@/home/fhcadmin/.claude/get-shit-done/workflows/execute-plan.md
@/home/fhcadmin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stack-crud/02-CONTEXT.md
@.planning/phases/02-stack-crud/02-RESEARCH.md
@api/internal/api/handlers/service.go (first 100 lines — constructor/List pattern)
@api/internal/container/validation.go
@api/internal/container/labels.go
@api/migrations/013_stacks_instances.up.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update migration 013 for soft-delete</name>
  <files>api/migrations/013_stacks_instances.up.sql, api/migrations/013_stacks_instances.down.sql</files>
  <action>
Update the existing migration 013 to add soft-delete support to stacks table:

1. Add `deleted_at TIMESTAMPTZ DEFAULT NULL` column to stacks table
2. Remove the simple `UNIQUE` constraint on name
3. Add partial unique index: `CREATE UNIQUE INDEX uq_stacks_name_active ON stacks(name) WHERE deleted_at IS NULL;`
4. Add index on deleted_at for trash queries: `CREATE INDEX idx_stacks_deleted_at ON stacks(deleted_at);`
5. Add `updated_at` trigger or leave as application-managed (application-managed is fine, consistent with existing tables)

The service_instances table stays as-is (Phase 3 concern). Keep the existing indexes.

Down migration: drop the new indexes before dropping tables (order matters for partial index).
  </action>
  <verify>Review migration SQL is valid. Run `cd /home/fhcadmin/projects/devarch/api && go build ./...` to ensure no compilation issues.</verify>
  <done>Migration 013 includes deleted_at column, partial unique index on active stacks, and deleted_at index.</done>
</task>

<task type="auto">
  <name>Task 2: Implement StackHandler with core CRUD</name>
  <files>api/internal/api/handlers/stack.go</files>
  <action>
Create StackHandler following the ServiceHandler pattern (constructor with db + containerClient).

**Struct:**
```go
type StackHandler struct {
    db              *sql.DB
    containerClient *container.Client
}

func NewStackHandler(db *sql.DB, cc *container.Client) *StackHandler
```

**Methods (each follows service.go patterns — JSON responses, error handling):**

1. **Create** `POST /stacks` — Accept `{name, description}`. Validate name with `container.ValidateName()`. Check uniqueness against active stacks (WHERE deleted_at IS NULL). Insert row. Return 201 + stack JSON.

2. **List** `GET /stacks` — Select all active stacks (WHERE deleted_at IS NULL) with instance count and running container count. Return as JSON array. Include summary: `{id, name, description, enabled, instance_count, running_count, created_at, updated_at}`. Instance count: `SELECT COUNT(*) FROM service_instances WHERE stack_id = stacks.id`. Running count can be 0 for now (requires container client queries — will be wired in Phase 3+). Use LEFT JOIN for counts.

3. **Get** `GET /stacks/{name}` — Get stack by name (active only). Include instance list with their statuses. Return 404 if not found. Use `chi.URLParam(r, "name")`.

4. **Update** `PUT /stacks/{name}` — Accept `{description}` only (name is immutable). Update description and updated_at. Return updated stack. 404 if not found.

5. **Delete** `DELETE /stacks/{name}` — Soft delete: SET deleted_at = NOW(), updated_at = NOW(). Stop any running containers for this stack's instances via containerClient (iterate instances, stop each). Return 200 with message. 404 if not found or already deleted.

**Response format:** Follow existing service handler pattern — direct JSON marshal of struct, not wrapped in `{success: true, data: ...}`.

**Error responses:** Use `http.Error(w, message, statusCode)` pattern from existing handlers. Include prescriptive fix suggestions for validation errors.

**Stack response struct:**
```go
type stackResponse struct {
    ID            int       `json:"id"`
    Name          string    `json:"name"`
    Description   string    `json:"description"`
    NetworkName   *string   `json:"network_name"`
    Enabled       bool      `json:"enabled"`
    InstanceCount int       `json:"instance_count"`
    RunningCount  int       `json:"running_count"`
    CreatedAt     time.Time `json:"created_at"`
    UpdatedAt     time.Time `json:"updated_at"`
}
```

Handle pq unique constraint violations (error code 23505) with user-friendly "stack name already exists" message.
  </action>
  <verify>`cd /home/fhcadmin/projects/devarch/api && go build ./...` compiles. `grep -c 'func.*StackHandler' internal/api/handlers/stack.go` returns 6 (constructor + 5 methods).</verify>
  <done>StackHandler exists with Create, List, Get, Update, Delete methods. All use existing validation. Soft delete implemented. Compiles cleanly.</done>
</task>

</tasks>

<verification>
- `cd /home/fhcadmin/projects/devarch/api && go build ./...` passes
- `grep 'deleted_at' migrations/013_stacks_instances.up.sql` shows soft-delete column
- `grep 'uq_stacks_name_active' migrations/013_stacks_instances.up.sql` shows partial unique index
- `grep -c 'func.*StackHandler' internal/api/handlers/stack.go` >= 6
- `grep 'container.ValidateName' internal/api/handlers/stack.go` confirms validation usage
</verification>

<success_criteria>
Migration 013 has soft-delete support. StackHandler compiles with Create/List/Get/Update/Delete. Uses existing container.ValidateName for prescriptive errors. Soft delete sets deleted_at, List excludes deleted.
</success_criteria>

<output>
After completion, create `.planning/phases/02-stack-crud/02-01-SUMMARY.md`
</output>
