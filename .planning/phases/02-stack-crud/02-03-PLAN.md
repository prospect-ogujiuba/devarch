---
phase: 02-stack-crud
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - dashboard/src/types/api.ts
  - dashboard/src/features/stacks/queries.ts
  - dashboard/src/components/layout/header.tsx
autonomous: true

must_haves:
  truths:
    - "Stack TypeScript types match API response shape"
    - "TanStack Query hooks exist for all stack CRUD operations"
    - "Mutations invalidate stacks query cache on success"
    - "Navigation includes Stacks link"
  artifacts:
    - path: "dashboard/src/types/api.ts"
      provides: "Stack type definitions"
      contains: "Stack"
    - path: "dashboard/src/features/stacks/queries.ts"
      provides: "Stack query and mutation hooks"
      exports: ["useStacks", "useStack", "useCreateStack", "useUpdateStack", "useDeleteStack", "useEnableStack", "useDisableStack", "useCloneStack", "useRenameStack", "useRestoreStack", "usePermanentDeleteStack", "useDeletePreview", "useTrashStacks"]
    - path: "dashboard/src/components/layout/header.tsx"
      provides: "Stacks navigation link"
      contains: "/stacks"
  key_links:
    - from: "dashboard/src/features/stacks/queries.ts"
      to: "dashboard/src/lib/api.ts"
      via: "api axios instance"
      pattern: "api\\.(get|post|put|delete)"
---

<objective>
Create Stack TypeScript types, TanStack Query hooks, and add navigation.

Purpose: Dashboard data layer for stacks — types, queries, mutations, and navigation entry point.
Output: Stack types in api.ts, full query/mutation hooks, Stacks nav item.
</objective>

<execution_context>
@/home/fhcadmin/.claude/get-shit-done/workflows/execute-plan.md
@/home/fhcadmin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-stack-crud/02-CONTEXT.md
@.planning/phases/02-stack-crud/02-RESEARCH.md
@dashboard/src/types/api.ts
@dashboard/src/features/services/queries.ts
@dashboard/src/components/layout/header.tsx
@dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stack types to api.ts</name>
  <files>dashboard/src/types/api.ts</files>
  <action>
Add these types at the end of the existing api.ts file:

```typescript
export interface Stack {
  id: number
  name: string
  description: string
  network_name: string | null
  enabled: boolean
  instance_count: number
  running_count: number
  created_at: string
  updated_at: string
  deleted_at?: string | null
  instances?: StackInstance[]
}

export interface StackInstance {
  id: number
  stack_id: number
  instance_id: string
  template_service_id: number | null
  container_name: string | null
  enabled: boolean
  created_at: string
  updated_at: string
}

export interface DeletePreview {
  stack_name: string
  instance_count: number
  container_names: string[]
}
```

These types match the API response shape from the Go handler (02-01).
  </action>
  <verify>`cd /home/fhcadmin/projects/devarch/dashboard && npx tsc --noEmit --skipLibCheck 2>&1 | head -20` — no new errors from types.</verify>
  <done>Stack, StackInstance, and DeletePreview types exported from api.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Create stack query and mutation hooks</name>
  <files>dashboard/src/features/stacks/queries.ts</files>
  <action>
Create `dashboard/src/features/stacks/queries.ts` following the pattern from `features/services/queries.ts`:

**Queries:**
1. `useStacks()` — GET /stacks, refetchInterval: 5000, queryKey: ['stacks']
2. `useStack(name)` — GET /stacks/{name}, enabled: !!name, refetchInterval: 5000, queryKey: ['stacks', name]
3. `useTrashStacks()` — GET /stacks/trash, queryKey: ['stacks', 'trash']
4. `useDeletePreview(name)` — GET /stacks/{name}/delete-preview, enabled: !!name, queryKey: ['stacks', name, 'delete-preview']

**Mutations (all invalidate ['stacks'] on success, show toast via sonner):**
5. `useCreateStack()` — POST /stacks, body: {name, description}
6. `useUpdateStack()` — PUT /stacks/{name}, body: {description}
7. `useDeleteStack()` — DELETE /stacks/{name} (soft delete)
8. `useEnableStack()` — POST /stacks/{name}/enable
9. `useDisableStack()` — POST /stacks/{name}/disable
10. `useCloneStack()` — POST /stacks/{name}/clone, body: {name: newName}
11. `useRenameStack()` — POST /stacks/{name}/rename, body: {name: newName}
12. `useRestoreStack()` — POST /stacks/trash/{name}/restore, also invalidate ['stacks', 'trash']
13. `usePermanentDeleteStack()` — DELETE /stacks/trash/{name}, also invalidate ['stacks', 'trash']

**Pattern:** Follow useCreateService/useDeleteService pattern exactly:
- useMutation with mutationFn
- onSuccess: toast.success + queryClient.invalidateQueries
- onError: toast.error with error.response?.data fallback

Import types from `@/types/api`. Import api from `@/lib/api`. Import toast from `sonner`.
  </action>
  <verify>`cd /home/fhcadmin/projects/devarch/dashboard && npx tsc --noEmit --skipLibCheck 2>&1 | head -20` — no new type errors.</verify>
  <done>All 13 stack query/mutation hooks created. Pattern matches existing service queries.</done>
</task>

<task type="auto">
  <name>Task 3: Add Stacks to navigation</name>
  <files>dashboard/src/components/layout/header.tsx</files>
  <action>
Add Stacks nav item to the `navItems` array in header.tsx:

1. Import `Layers` from lucide-react (represents stacks well)
2. Add entry after Overview, before Services:
```typescript
{ to: '/stacks' as const, icon: Layers, label: 'Stacks' },
```

This makes Stacks the second nav item, reflecting its importance in the new workflow.
  </action>
  <verify>Check header.tsx has Stacks in navItems array. `grep 'Stacks' dashboard/src/components/layout/header.tsx`.</verify>
  <done>Stacks navigation link appears in header between Overview and Services.</done>
</task>

</tasks>

<verification>
- `cd /home/fhcadmin/projects/devarch/dashboard && npx tsc --noEmit --skipLibCheck` passes (or only pre-existing errors)
- `grep 'Stack' dashboard/src/types/api.ts` shows types
- `grep 'useStacks\|useCreateStack\|useDeleteStack' dashboard/src/features/stacks/queries.ts` shows hooks
- `grep 'Stacks' dashboard/src/components/layout/header.tsx` shows nav item
</verification>

<success_criteria>
Stack types match API contract. All CRUD + advanced ops have query/mutation hooks. Stacks appears in navigation. TypeScript compiles.
</success_criteria>

<output>
After completion, create `.planning/phases/02-stack-crud/02-03-SUMMARY.md`
</output>
