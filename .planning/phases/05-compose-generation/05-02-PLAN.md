---
phase: 05-compose-generation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dashboard/src/features/stacks/queries.ts
  - dashboard/src/types/api.ts
  - dashboard/src/routes/stacks/$name.tsx
autonomous: true

must_haves:
  truths:
    - "Stack detail page has a Compose tab showing generated YAML"
    - "YAML displayed in CodeMirror with syntax highlighting (not plain pre tag)"
    - "Warnings from compose generation shown below YAML preview"
    - "Download button saves docker-compose.yml file to user's machine"
    - "Loading state shown while compose is being fetched"
    - "Empty/error states handled gracefully"
  artifacts:
    - path: "dashboard/src/features/stacks/queries.ts"
      provides: "useStackCompose query hook"
    - path: "dashboard/src/types/api.ts"
      provides: "StackCompose response type"
    - path: "dashboard/src/routes/stacks/$name.tsx"
      provides: "Compose tab with CodeMirror, warnings, download"
  key_links:
    - from: "dashboard/src/routes/stacks/$name.tsx"
      to: "dashboard/src/features/stacks/queries.ts"
      via: "useStackCompose hook"
      pattern: "useStackCompose"
    - from: "dashboard/src/features/stacks/queries.ts"
      to: "/api/v1/stacks/{name}/compose"
      via: "api.get fetch call"
      pattern: "stacks/.*compose"
    - from: "dashboard/src/routes/stacks/$name.tsx"
      to: "dashboard/src/components/services/code-editor.tsx"
      via: "CodeEditor component import"
      pattern: "CodeEditor"
---

<objective>
Dashboard compose preview tab on stack detail page with CodeMirror YAML editor, warning display, and download capability.

Purpose: Visual feedback for compose generation — users see exactly what YAML will be produced for their stack, with warnings about potential issues (disabled deps, port conflicts).
Output: Compose tab on stack detail, query hook, type definitions.
</objective>

<execution_context>
@/home/priz/.claude/get-shit-done/workflows/execute-plan.md
@/home/priz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-compose-generation/05-01-SUMMARY.md
@dashboard/src/routes/stacks/$name.tsx
@dashboard/src/features/stacks/queries.ts
@dashboard/src/types/api.ts
@dashboard/src/components/services/code-editor.tsx
@dashboard/src/routes/services/$name.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stack compose type and query hook</name>
  <files>dashboard/src/types/api.ts, dashboard/src/features/stacks/queries.ts</files>
  <action>
**In dashboard/src/types/api.ts**, add at the end (after NetworkStatus):

```typescript
export interface StackCompose {
  yaml: string
  warnings: string[]
  instance_count: number
}
```

**In dashboard/src/features/stacks/queries.ts**, add a new query hook after useStackNetwork:

```typescript
export function useStackCompose(name: string) {
  return useQuery({
    queryKey: ['stacks', name, 'compose'],
    queryFn: async () => {
      const response = await api.get<StackCompose>(`/stacks/${name}/compose`)
      return response.data
    },
    enabled: !!name,
  })
}
```

Import StackCompose type from '@/types/api' — add it to the existing import line that already imports Stack, DeletePreview, NetworkStatus.

Note: This query does NOT use refetchInterval (compose is generated on demand, not polling). It also does NOT request text/yaml — the endpoint returns JSON with yaml as a string field.
  </action>
  <verify>
Run `cd /home/priz/projects/devarch/dashboard && npx tsc --noEmit` — type check passes. Verify StackCompose type exists and useStackCompose hook is exported.
  </verify>
  <done>
StackCompose type added to api.ts. useStackCompose query hook fetches from /stacks/{name}/compose and returns typed StackCompose response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compose tab on stack detail page</name>
  <files>dashboard/src/routes/stacks/$name.tsx</files>
  <action>
Add a Compose tab to the stack detail page. The current page has info cards (status, instances, running, created), an instances grid, and a network card — all in a flat layout with no tabs. Add a tabbed section below the info cards that contains two tabs: "Instances" (existing instance grid + network card content) and "Compose" (new).

Implementation:

1. Add imports at top:
   - `import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'`
   - `import { CodeEditor } from '@/components/services/code-editor'`
   - `import { useStackCompose } from '@/features/stacks/queries'`
   - `import { Download, AlertTriangle } from 'lucide-react'` (add to existing lucide import)

2. In StackDetailPage component, add:
   - `const { data: composeData, isLoading: composeLoading } = useStackCompose(name)`

3. Add a download helper function inside StackDetailPage:
   ```typescript
   const handleDownload = () => {
     if (!composeData?.yaml) return
     const blob = new Blob([composeData.yaml], { type: 'text/yaml' })
     const url = URL.createObjectURL(blob)
     const a = document.createElement('a')
     a.href = url
     a.download = `docker-compose-${name}.yml`
     a.click()
     URL.revokeObjectURL(url)
   }
   ```

4. Restructure the page layout: keep the stats cards grid at the top. Below it, wrap the instances section and the new compose section in Tabs:
   ```
   <Tabs defaultValue="instances" className="space-y-4">
     <TabsList>
       <TabsTrigger value="instances">Instances ({instances.length})</TabsTrigger>
       <TabsTrigger value="compose">Compose</TabsTrigger>
     </TabsList>

     <TabsContent value="instances">
       {/* Move existing instances Card and Network Card here */}
     </TabsContent>

     <TabsContent value="compose">
       <Card>
         <CardHeader>
           <div className="flex items-center justify-between">
             <CardTitle className="text-base">Generated Compose YAML</CardTitle>
             <Button size="sm" variant="outline" onClick={handleDownload} disabled={!composeData?.yaml}>
               <Download className="size-4" />
               Download
             </Button>
           </div>
         </CardHeader>
         <CardContent className="space-y-4">
           {composeLoading ? (
             <div className="flex items-center justify-center py-8">
               <Loader2 className="size-6 animate-spin text-muted-foreground" />
             </div>
           ) : composeData?.yaml ? (
             <CodeEditor value={composeData.yaml} onChange={() => {}} language="yaml" readOnly />
           ) : (
             <div className="text-center py-8 text-muted-foreground">
               <p>No compose YAML available</p>
               <p className="text-sm mt-1">Add instances to this stack to generate compose configuration</p>
             </div>
           )}

           {composeData?.warnings && composeData.warnings.length > 0 && (
             <div className="space-y-2">
               <h4 className="text-sm font-medium flex items-center gap-2">
                 <AlertTriangle className="size-4 text-yellow-500" />
                 Warnings ({composeData.warnings.length})
               </h4>
               <div className="space-y-1">
                 {composeData.warnings.map((warning, i) => (
                   <div key={i} className="text-sm text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-950/20 px-3 py-2 rounded-md">
                     {warning}
                   </div>
                 ))}
               </div>
             </div>
           )}
         </CardContent>
       </Card>
     </TabsContent>
   </Tabs>
   ```

5. Keep the "Add Instance" button accessible — either in the Instances tab header or keep the existing placement. The existing instances Card header already has an "Add Instance" button, so this works naturally inside the tab.

Note: CodeEditor onChange is set to no-op since this is readOnly. The existing CodeEditor component handles readOnly mode via EditorState.readOnly.of(true).
  </action>
  <verify>
Run `cd /home/priz/projects/devarch/dashboard && npx tsc --noEmit` — type check passes. Run `cd /home/priz/projects/devarch/dashboard && npm run build` — production build succeeds. Visually verify the Compose tab renders by checking the build output has no errors.
  </verify>
  <done>
Stack detail page has Instances and Compose tabs. Compose tab shows CodeMirror read-only YAML preview with syntax highlighting, warnings section below with yellow styling, download button in card header. Loading and empty states handled.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/priz/projects/devarch/dashboard && npm run build` succeeds
2. StackCompose type exists in api.ts
3. useStackCompose hook fetches from correct endpoint
4. Stack detail page renders tabs (Instances, Compose)
5. Compose tab uses CodeEditor component with language="yaml" and readOnly
6. Download button creates blob and triggers download
7. Warnings displayed with AlertTriangle icon and yellow styling
</verification>

<success_criteria>
- Compose tab visible on stack detail page with YAML preview in CodeMirror
- Warnings from generation displayed below YAML
- Download button saves docker-compose-{stack}.yml
- No regressions to existing stack detail functionality (instances, network, dialogs)
- Dashboard builds successfully with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-compose-generation/05-02-SUMMARY.md`
</output>
