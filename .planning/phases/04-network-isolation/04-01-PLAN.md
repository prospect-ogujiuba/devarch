---
phase: 04-network-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/internal/container/client.go
  - api/internal/container/types.go
  - api/internal/container/validation.go
  - api/internal/container/labels.go
  - api/internal/api/handlers/stack.go
  - api/internal/api/handlers/instance.go
  - api/internal/api/routes.go
  - api/migrations/018_network_name_default.up.sql
  - api/migrations/018_network_name_default.down.sql
autonomous: true

must_haves:
  truths:
    - "CreateNetwork is idempotent: calling twice with same name succeeds without error"
    - "RemoveNetwork removes a network by name, fails gracefully if not found"
    - "ListNetworks returns devarch-labeled networks"
    - "InspectNetwork returns network metadata (name, labels, connected containers)"
    - "Instance creation rejects names that cause devarch-{stack}-{instance} to exceed 127 chars"
    - "Stack creation auto-populates network_name to devarch-{stack}-net"
    - "GET /stacks/{name}/network returns network status from container runtime"
  artifacts:
    - path: "api/internal/container/client.go"
      provides: "Working CreateNetwork, RemoveNetwork, ListNetworks, InspectNetwork implementations"
      contains: "func (c *Client) CreateNetwork"
    - path: "api/internal/container/types.go"
      provides: "NetworkInfo type and InspectNetwork in Runtime interface"
      contains: "InspectNetwork"
    - path: "api/internal/container/validation.go"
      provides: "ValidateContainerName function for combined length check"
      contains: "ValidateContainerName"
    - path: "api/migrations/018_network_name_default.up.sql"
      provides: "DB migration setting network_name default"
    - path: "api/internal/api/handlers/stack.go"
      provides: "NetworkStatus handler and auto-populate network_name on create"
      contains: "NetworkStatus"
  key_links:
    - from: "api/internal/api/handlers/stack.go"
      to: "api/internal/container/client.go"
      via: "containerClient.InspectNetwork call in NetworkStatus handler"
      pattern: "InspectNetwork"
    - from: "api/internal/api/handlers/instance.go"
      to: "api/internal/container/validation.go"
      via: "ValidateContainerName call in Create handler"
      pattern: "ValidateContainerName"
---

<objective>
Implement container client network operations (replace Phase 1 stubs), add container name length validation, auto-populate stack network_name, and expose network status API endpoint.

Purpose: This is the backend foundation for network isolation — without working CreateNetwork/RemoveNetwork, Phase 6 (plan/apply) cannot create isolated stack networks. Without name length validation, long stack+instance combos would silently produce invalid container names.

Output: Working network CRUD on container.Client, container name length enforcement, auto-populated network_name on stacks, and GET /stacks/{name}/network endpoint.
</objective>

<execution_context>
@/home/fhcadmin/.claude/get-shit-done/workflows/execute-plan.md
@/home/fhcadmin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-network-isolation/04-CONTEXT.md
@.planning/phases/04-network-isolation/04-RESEARCH.md
@api/internal/container/client.go
@api/internal/container/types.go
@api/internal/container/labels.go
@api/internal/container/validation.go
@api/internal/api/handlers/stack.go
@api/internal/api/handlers/instance.go
@api/internal/api/routes.go
@api/migrations/013_stacks_instances.up.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement container client network methods and add InspectNetwork</name>
  <files>
    api/internal/container/client.go
    api/internal/container/types.go
  </files>
  <action>
  **types.go changes:**
  1. Add `NetworkInfo` struct:
     ```go
     type NetworkInfo struct {
         Name       string
         ID         string
         Driver     string
         Labels     map[string]string
         Containers []string  // connected container names
         Created    time.Time
     }
     ```
  2. Add `InspectNetwork(name string) (*NetworkInfo, error)` to the `Runtime` interface.

  **client.go changes:**
  Replace the three stub methods (lines 463-473) with real implementations. All methods use `c.execCommand()` which already handles sudo and runtime selection.

  1. `CreateNetwork(name string, labels map[string]string) error`:
     - First check if network exists: `c.execCommand("network", "inspect", name)`. If no error, return nil (idempotent).
     - If error (not found), create: build args `["network", "create"]`, append `--label k=v` for each label, append `--driver bridge` explicitly, append name.
     - Execute via `c.execCommand(args...)`.
     - Return nil on success, wrapped error on failure.

  2. `RemoveNetwork(name string) error`:
     - Execute `c.execCommand("network", "rm", name)`.
     - If error contains "not found" or "no such network" (case-insensitive), return nil (graceful).
     - Otherwise return wrapped error.

  3. `ListNetworks() ([]string, error)`:
     - Execute `c.execCommand("network", "ls", "--filter", "label=devarch.managed_by=devarch", "--format", "{{.Name}}")`.
     - Parse output line-by-line (same pattern as `parseNamesList`).
     - Return names slice.

  4. `InspectNetwork(name string) (*NetworkInfo, error)`:
     - Execute `c.execCommand("network", "inspect", name)`.
     - Parse JSON output. Both Docker and Podman return JSON array with one element.
     - Extract: Name, Id, Driver, Labels, Containers (container names from the Containers map).
     - Return populated `NetworkInfo`.
     - If network not found, return nil + descriptive error.

  Remove the `ErrNotImplemented` variable (or keep it for reference but unused — removing is cleaner since nothing should reference it after this).
  </action>
  <verify>
  - `go build ./...` from `api/` succeeds with no errors.
  - `grep -r "ErrNotImplemented" api/internal/container/` returns no results (or only a test reference).
  - The `Runtime` interface in types.go includes `InspectNetwork`.
  - `CreateNetwork` implementation checks existence before creating.
  </verify>
  <done>
  - All four network methods implemented on Client using execCommand pattern.
  - NetworkInfo type added with relevant fields.
  - Runtime interface extended with InspectNetwork.
  - Idempotent CreateNetwork (no error if exists).
  - Graceful RemoveNetwork (no error if not found).
  - ListNetworks filters by devarch.managed_by label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Container name length validation, network_name auto-population, and network status endpoint</name>
  <files>
    api/internal/container/validation.go
    api/internal/container/labels.go
    api/internal/api/handlers/stack.go
    api/internal/api/handlers/instance.go
    api/internal/api/routes.go
    api/migrations/018_network_name_default.up.sql
    api/migrations/018_network_name_default.down.sql
  </files>
  <action>
  **validation.go changes:**
  Add `ValidateContainerName(stackName, instanceName string) error`:
  - Compute full name via `ContainerName(stackName, instanceName)` (from labels.go).
  - If len > 127, return prescriptive error: `"container name %q (%d chars) exceeds 127-char limit — shorten stack name %q or instance name %q"`.
  - Also validate the combined name is DNS-safe (lowercase alnum + hyphens). It should be by construction since both parts are validated, but belt-and-suspenders.

  **labels.go changes:**
  Add `ValidateNetworkName(stackName string) error`:
  - Compute full name via `NetworkName(stackName)`.
  - If len > 63, return prescriptive error.
  - Validate DNS-safe pattern.

  **Migration 018 (network_name_default):**
  `018_network_name_default.up.sql`:
  ```sql
  -- Auto-populate network_name for new stacks
  ALTER TABLE stacks ALTER COLUMN network_name SET DEFAULT NULL;

  -- Backfill existing stacks that have no network_name
  UPDATE stacks SET network_name = 'devarch-' || name || '-net'
  WHERE network_name IS NULL;
  ```
  `018_network_name_default.down.sql`:
  ```sql
  UPDATE stacks SET network_name = NULL WHERE network_name LIKE 'devarch-%-net';
  ALTER TABLE stacks ALTER COLUMN network_name DROP DEFAULT;
  ```

  **stack.go changes:**
  1. In `Create` handler: compute and pass network_name to INSERT. Before inserting, generate `networkName := container.NetworkName(req.Name)`. Allow optional `network_name` field in createStackRequest. If user provides it, validate with `ValidateName`; if not, use computed default. Update INSERT to include network_name: `INSERT INTO stacks (name, description, network_name) VALUES ($1, $2, $3)`.

  2. Add `NetworkStatus` handler method on StackHandler:
     ```go
     func (h *StackHandler) NetworkStatus(w http.ResponseWriter, r *http.Request) {
     ```
     - Get stack by name (existing pattern).
     - If stack has network_name, call `h.containerClient.InspectNetwork(*stack.NetworkName)`.
     - If network exists, return JSON with: name, driver, status ("active"), connected containers, labels.
     - If network doesn't exist, return JSON with: name, status ("not_created"), empty containers.
     - Response shape:
       ```json
       {
         "network_name": "devarch-mystack-net",
         "status": "active|not_created",
         "driver": "bridge",
         "containers": ["devarch-mystack-postgres", "devarch-mystack-redis"],
         "labels": {"devarch.managed_by": "devarch", "devarch.stack_id": "mystack"}
       }
       ```

  3. In Clone handler: ensure cloned stack gets a new network_name computed from the new stack name (not copied from source).

  4. In Rename handler: ensure renamed stack gets a new network_name computed from the new name.

  **instance.go changes:**
  In `Create` handler (before line 111): add `if err := container.ValidateContainerName(stackActualName, req.InstanceID); err != nil { http.Error(w, err.Error(), http.StatusBadRequest); return }`.
  Similarly in `Duplicate` handler (before line 493) and `Rename` handler.

  **routes.go changes:**
  Add route inside `/{name}` stack routes: `r.Get("/network", stackHandler.NetworkStatus)`.
  </action>
  <verify>
  - `go build ./...` from `api/` succeeds.
  - Migration files exist and have valid SQL.
  - `grep "ValidateContainerName" api/internal/api/handlers/instance.go` shows calls in Create, Duplicate, and Rename.
  - `grep "NetworkStatus" api/internal/api/routes.go` shows the route registration.
  - `grep "network_name" api/internal/api/handlers/stack.go` shows it's set in Create, Clone, and Rename.
  </verify>
  <done>
  - ValidateContainerName rejects combined names > 127 chars with prescriptive error.
  - ValidateNetworkName rejects network names > 63 chars.
  - Stack creation auto-populates network_name (default: devarch-{stack}-net, overridable).
  - Clone/Rename recompute network_name for new stack name.
  - Instance Create/Duplicate/Rename validate container name length.
  - GET /stacks/{name}/network returns live network status from container runtime.
  - Migration backfills existing stacks.
  </done>
</task>

</tasks>

<verification>
1. `cd api && go build ./...` — compiles without errors
2. `cd api && go test ./internal/container/...` — existing tests still pass
3. `grep -c "ErrNotImplemented" api/internal/container/client.go` — returns 0 (stubs replaced)
4. Migration files exist at api/migrations/018_*.sql
5. Network status endpoint registered in routes.go
6. Container name validation called in instance Create/Duplicate/Rename
</verification>

<success_criteria>
- Container client network methods work for both Docker and Podman (via CLI exec pattern)
- CreateNetwork is idempotent, RemoveNetwork is graceful
- Instance creation fails early if combined container name exceeds limit
- Stack creation always produces a network_name
- Network status endpoint returns runtime-queried network info
- All existing tests pass, code compiles
</success_criteria>

<output>
After completion, create `.planning/phases/04-network-isolation/04-01-SUMMARY.md`
</output>
