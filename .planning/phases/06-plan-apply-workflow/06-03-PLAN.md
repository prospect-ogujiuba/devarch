---
phase: 06-plan-apply-workflow
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - dashboard/src/types/api.ts
  - dashboard/src/features/stacks/queries.ts
  - dashboard/src/routes/stacks/$name.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Generate Plan to see structured diff preview"
    - "Diff shows adds in green, modifications in yellow, removals in red"
    - "User can click Apply to execute the plan"
    - "Apply errors (409 stale, 409 locked, 500) show appropriate toast messages"
    - "Deploy tab appears alongside Instances and Compose tabs"
    - "After successful apply, plan clears and stack data refreshes"
  artifacts:
    - path: "dashboard/src/types/api.ts"
      provides: "StackPlan, PlanChange, PlanFieldChange types"
      contains: "StackPlan"
    - path: "dashboard/src/features/stacks/queries.ts"
      provides: "useGeneratePlan and useApplyPlan mutation hooks"
      contains: "useGeneratePlan"
    - path: "dashboard/src/routes/stacks/$name.tsx"
      provides: "Deploy tab with plan diff visualization and apply button"
      contains: "Deploy"
  key_links:
    - from: "dashboard/src/routes/stacks/$name.tsx"
      to: "dashboard/src/features/stacks/queries.ts"
      via: "imports useGeneratePlan and useApplyPlan hooks"
      pattern: "useGeneratePlan|useApplyPlan"
    - from: "dashboard/src/features/stacks/queries.ts"
      to: "/api/v1/stacks/{name}/plan"
      via: "fetch calls to plan and apply endpoints"
      pattern: "stacks/.*/(plan|apply)"
    - from: "dashboard/src/types/api.ts"
      to: "dashboard/src/features/stacks/queries.ts"
      via: "StackPlan type used in query return types"
      pattern: "StackPlan"
---

<objective>
Add Deploy tab to stack detail page with plan preview and apply execution.

Purpose: Users see what will change before applying (Terraform-style safety UX).
Output: Dashboard types, query hooks, and Deploy tab with diff visualization.
</objective>

<execution_context>
@/home/priz/.claude/get-shit-done/workflows/execute-plan.md
@/home/priz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-plan-apply-workflow/06-CONTEXT.md
@.planning/phases/06-plan-apply-workflow/06-02-SUMMARY.md

@dashboard/src/types/api.ts (existing type definitions — StackCompose, NetworkStatus etc.)
@dashboard/src/features/stacks/queries.ts (existing query/mutation patterns)
@dashboard/src/routes/stacks/$name.tsx (existing stack detail page with tabs)
@dashboard/src/lib/api.ts (api instance)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard types and query hooks</name>
  <files>dashboard/src/types/api.ts, dashboard/src/features/stacks/queries.ts</files>
  <action>
**api.ts** — Add plan/apply types at the end of the file:

```typescript
export interface PlanFieldChange {
  old: unknown
  new: unknown
  source: string
}

export interface PlanChange {
  action: 'add' | 'modify' | 'remove'
  instance_id: string
  template_name: string
  container_name: string
  fields: Record<string, PlanFieldChange> | null
}

export interface StackPlan {
  stack_name: string
  stack_id: number
  changes: PlanChange[]
  token: string
  generated_at: string
  warnings: string[]
}

export interface ApplyResult {
  status: string
  output: string
}
```

**queries.ts** — Add two mutation hooks:

`useGeneratePlan(name: string)`:
- useMutation that calls `api.get<StackPlan>(\`/stacks/${name}/plan\`)`
- No automatic cache invalidation (plan is ephemeral, not cached)
- onError: toast.error with response data or fallback message

`useApplyPlan(name: string)`:
- useMutation that calls `api.post<ApplyResult>(\`/stacks/${name}/apply\`, { token })`
- mutationFn receives `{ token: string }` as argument
- onSuccess: toast.success('Stack deployed'), invalidate queryKeys: ['stacks', name], ['stacks'], ['stacks', name, 'compose'], ['stacks', name, 'network']
- onError: check error.response?.status:
  - 409: toast.error('Plan is stale or another operation in progress. Regenerate plan.')
  - Other: toast.error(error.response?.data || 'Apply failed')
  </action>
  <verify>
`cd /home/priz/projects/devarch/dashboard && npx tsc --noEmit` passes without type errors.
  </verify>
  <done>
StackPlan and PlanChange types defined. useGeneratePlan and useApplyPlan hooks available for Deploy tab.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy tab with diff visualization</name>
  <files>dashboard/src/routes/stacks/$name.tsx</files>
  <action>
Modify the existing stack detail page to add a "Deploy" tab alongside Instances and Compose.

**State additions:**
- `const [currentPlan, setCurrentPlan] = useState<StackPlan | null>(null)` for holding the ephemeral plan
- Import `useGeneratePlan`, `useApplyPlan` from queries
- Initialize: `const generatePlan = useGeneratePlan(name)`, `const applyPlan = useApplyPlan(name)`

**Tab changes:**
- Add `<TabsTrigger value="deploy">Deploy</TabsTrigger>` after the Compose trigger
- Add `<TabsContent value="deploy">` with the Deploy tab content

**Deploy tab content structure:**

1. **Header area**: "Deploy Stack" title with "Generate Plan" button
   - Button onClick: `generatePlan.mutate(undefined, { onSuccess: (data) => setCurrentPlan(data.data) })`
   - Show spinner on generatePlan.isPending
   - Disable button during apply

2. **Empty state** (when no plan generated yet):
   - Centered content with Rocket or Play icon (use `Play` from lucide-react)
   - "Generate a plan to preview changes"
   - "Compare running state against desired configuration"

3. **Plan diff display** (when currentPlan exists):
   - If changes is empty: green success message "Stack is up to date — no changes needed"
   - If changes exist:
     - Summary line: "N change(s): X to add, Y to modify, Z to remove"
     - Each change as a card/row:
       - Add (`+`): green left border, green `+` prefix, instance_id, template_name, container_name
       - Modify (`~`): yellow/amber left border, yellow `~` prefix, instance_id, expandable field changes
       - Remove (`-`): red left border, red `-` prefix, instance_id, container_name
     - For modify changes with fields: show each field as "field: old -> new" with muted text for old, bold for new
     - Use Tailwind classes: `border-l-4 border-green-500`, `border-l-4 border-yellow-500`, `border-l-4 border-red-500`

4. **Apply button area** (when plan has changes):
   - "Apply Changes" button (primary/default variant)
   - onClick: `applyPlan.mutate({ token: currentPlan.token }, { onSuccess: () => setCurrentPlan(null) })`
   - Show spinner on applyPlan.isPending
   - Disable during pending
   - "Regenerate Plan" secondary button next to it (clears current plan and generates new one)

5. **Apply result** (after successful apply):
   - Plan clears (setCurrentPlan(null) in onSuccess)
   - Cache invalidation triggers data refresh

6. **Warnings display** (if plan has warnings):
   - Same warning style as compose tab (yellow background, AlertTriangle icon)

**Imports to add:** Play (or Rocket) from lucide-react, StackPlan type, useGeneratePlan/useApplyPlan hooks. Import `cn` if not already imported.

Keep the existing Instances and Compose tab content unchanged. Only add the new Deploy tab trigger and content.
  </action>
  <verify>
`cd /home/priz/projects/devarch/dashboard && npx tsc --noEmit` passes. `npm run build` succeeds.
  </verify>
  <done>
Deploy tab visible on stack detail page. Generate Plan shows structured diff with color-coded adds/modifies/removes. Apply executes plan and refreshes data. 409 errors show appropriate messages.
  </done>
</task>

</tasks>

<verification>
- `cd /home/priz/projects/devarch/dashboard && npm run build` succeeds
- `npx tsc --noEmit` passes
- Stack detail page shows three tabs: Instances, Compose, Deploy
- Deploy tab has Generate Plan button, diff preview with color coding, Apply button
- Types match API response structure from plan endpoint
</verification>

<success_criteria>
- Deploy tab renders on stack detail page (CONTEXT decision: "Deploy" tab name)
- Generate Plan calls GET /stacks/{name}/plan and shows structured diff
- Diff color-coded: green adds, yellow modifications, red removals (CONTEXT decision)
- Per-field detail visible for modifications (CONTEXT decision)
- Apply calls POST /stacks/{name}/apply with staleness token
- 409 errors handled with clear user messaging
- Successful apply clears plan and refreshes stack data
</success_criteria>

<output>
After completion, create `.planning/phases/06-plan-apply-workflow/06-03-SUMMARY.md`
</output>
