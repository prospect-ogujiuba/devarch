---
phase: 03-service-instances
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - dashboard/src/components/instances/effective-config-tab.tsx
  - dashboard/src/components/instances/instance-actions.tsx
  - dashboard/src/routes/stacks/$name.instances.$instance.tsx
  - dashboard/src/routes/stacks/$name.tsx
autonomous: false

must_haves:
  truths:
    - "User can view effective config showing merged template + overrides"
    - "Overridden values are visually distinguished in effective config view"
    - "User can copy effective config as YAML or JSON"
    - "User can duplicate instance within same stack"
    - "User can enable/disable instance"
    - "User can rename instance"
    - "User can delete instance with blast radius preview"
  artifacts:
    - path: "dashboard/src/components/instances/effective-config-tab.tsx"
      provides: "Read-only effective config display"
    - path: "dashboard/src/components/instances/instance-actions.tsx"
      provides: "Instance lifecycle action dialogs"
  key_links:
    - from: "effective-config-tab.tsx"
      to: "instance-queries.ts useEffectiveConfig"
      via: "query hook"
      pattern: "useEffectiveConfig"
    - from: "instance-actions.tsx"
      to: "instance-queries.ts mutations"
      via: "mutation hooks"
      pattern: "useDeleteInstance|useDuplicateInstance|useRenameInstance"
---

<objective>
Add effective config preview tab and instance lifecycle action dialogs.

Purpose: Complete the instance management UX — users see what will run (effective config) and manage instance lifecycle (duplicate, rename, delete, enable/disable).
Output: Effective config tab with YAML/JSON copy, action dialogs wired into instance detail page.
</objective>

<execution_context>
@/home/priz/.claude/get-shit-done/workflows/execute-plan.md
@/home/priz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-service-instances/03-CONTEXT.md
@.planning/phases/03-service-instances/03-04-SUMMARY.md

@dashboard/src/routes/stacks/$name.instances.$instance.tsx
@dashboard/src/lib/instance-queries.ts
@dashboard/src/types/api.ts
@dashboard/src/components/stacks/delete-stack-dialog.tsx
@dashboard/src/components/stacks/clone-stack-dialog.tsx
@dashboard/src/components/stacks/rename-stack-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Effective config tab + instance action dialogs</name>
  <files>
    dashboard/src/components/instances/effective-config-tab.tsx
    dashboard/src/components/instances/instance-actions.tsx
    dashboard/src/routes/stacks/$name.instances.$instance.tsx
    dashboard/src/routes/stacks/$name.tsx
  </files>
  <action>
**Effective config tab (effective-config-tab.tsx):**

Props: `{ stackName: string, instanceId: string }`

1. Fetch effective config using useEffectiveConfig hook
2. Display as structured read-only cards matching the override editor layout (per CONTEXT.md):
   - Image section: image_name:image_tag, restart_policy, command
   - Ports card: table of host_port:container_port/protocol
   - Volumes card: table of source -> target (type, read_only)
   - Environment card: key-value table
   - Labels card: key-value table
   - Domains card: domain list
   - Healthcheck card: field display (test, interval, timeout, retries, start_period)
   - Dependencies card: list (template-only, noted as "from template")
   - Config Files card: file list with preview
3. Overridden values marked with subtle colored left border (same visual language as override editors, per CONTEXT.md)
4. Use `overrides_applied` from API response to determine which values to mark
5. Copy button in header: YAML default format. Toggle to JSON. Use js-yaml for YAML serialization (check if already in package.json, if not use JSON.stringify for JSON and manual YAML-like formatting). Copy to clipboard with navigator.clipboard.writeText.
6. Read-only — no edit controls, just display

**Instance action dialogs (instance-actions.tsx):**

Create action dialog components following existing stack dialog patterns:

- **DeleteInstanceDialog**: Fetch delete-preview, show blast radius (instance name, template, override count, container name). Confirm button calls useDeleteInstance, on success navigate back to stack detail page.
- **DuplicateInstanceDialog**: Input for new instance name (auto-filled with "{instance}-copy"), optional description. Submit calls useDuplicateInstance.
- **RenameInstanceDialog**: Input for new name, validates with existing name validation. Submit calls useRenameInstance.
- **EnableDisableToggle**: Simple toggle button in header (no dialog needed). Calls useUpdateInstance with {enabled: !current}. Show loading state during mutation.

**Wire into instance detail page ($name.instances.$instance.tsx):**
- Replace Effective Config placeholder tab with effective-config-tab component
- Wire header action buttons to dialogs
- Add enable/disable toggle to header

**Update stack detail page ($name.tsx):**
- Wire instance card clicks to navigate to /stacks/{name}/instances/{instance}
- Add context menu or action buttons on instance cards: delete, duplicate, enable/disable (per CONTEXT.md: actions accessible from list AND detail)
  </action>
  <verify>`npm run build:strict` passes. Effective config tab shows merged data. Delete dialog shows preview. Duplicate creates new instance.</verify>
  <done>Effective config tab displays merged view with override indicators, all lifecycle actions work from both list and detail views</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete instance management: add from template catalog, edit overrides with template placeholders, view effective config, lifecycle actions (duplicate/rename/delete/enable-disable)</what-built>
  <how-to-verify>
    1. Navigate to a stack detail page at http://localhost:5174/stacks/{stack-name}
    2. Click "Add Instance" — template catalog should appear with search
    3. Select a template, confirm name, click Add — instance should appear in list
    4. Click instance card — instance detail page with tabs
    5. Go to Ports tab — template ports shown as muted placeholders
    6. Add a port override, click Save — should persist
    7. Go to Environment tab — add env var override, save
    8. Go to Effective Config tab — should show merged view with overridden values highlighted
    9. Click copy (YAML) — clipboard should have YAML content
    10. Test Duplicate from instance detail — new instance created
    11. Test Delete from instance detail — preview shown, confirm deletes
    12. Test Enable/Disable toggle
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Effective config tab loads merged data from API
- Override indicators (colored borders) appear on overridden values
- Copy produces valid YAML/JSON
- Delete shows blast radius preview before confirming
- Duplicate creates new instance with copied overrides
- Rename updates instance name and container name
- Enable/disable toggles persist
- Navigation works: stack list -> stack detail -> instance detail and back
</verification>

<success_criteria>
- INST-10 (effective config resolver) visible in dashboard
- INST-11 (list/get/update/delete) complete from dashboard
- INST-12 (dashboard UI) fully complete
- All 6 phase success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-instances/03-05-SUMMARY.md`
</output>
