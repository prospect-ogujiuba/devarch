---
phase: 03-service-instances
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - dashboard/src/routes/stacks/$name.instances.$instance.tsx
  - dashboard/src/components/instances/override-ports.tsx
  - dashboard/src/components/instances/override-volumes.tsx
  - dashboard/src/components/instances/override-env-vars.tsx
  - dashboard/src/components/instances/override-labels.tsx
  - dashboard/src/components/instances/override-domains.tsx
  - dashboard/src/components/instances/override-healthcheck.tsx
  - dashboard/src/components/instances/override-config-files.tsx
autonomous: true

must_haves:
  truths:
    - "User can view instance detail page with tabbed layout"
    - "User can edit port overrides with template values as placeholders"
    - "User can edit volume overrides"
    - "User can edit env var overrides with template values as placeholders"
    - "User can edit label overrides (devarch.* read-only)"
    - "User can edit domain overrides"
    - "User can edit healthcheck overrides with individual fields"
    - "User can edit config file overrides with CodeMirror"
    - "User can reset individual overrides and reset all"
    - "Changes require explicit save (not auto-save)"
  artifacts:
    - path: "dashboard/src/routes/stacks/$name.instances.$instance.tsx"
      provides: "Instance detail page with tabs"
    - path: "dashboard/src/components/instances/override-ports.tsx"
      provides: "Port override editor"
    - path: "dashboard/src/components/instances/override-env-vars.tsx"
      provides: "Env var override editor with template placeholders"
  key_links:
    - from: "dashboard/src/routes/stacks/$name.instances.$instance.tsx"
      to: "dashboard/src/lib/instance-queries.ts"
      via: "useInstance hook"
      pattern: "useInstance"
    - from: "override-*.tsx components"
      to: "instance mutation hooks"
      via: "useUpdateInstance* hooks"
      pattern: "useUpdateInstance"
---

<objective>
Build the instance detail page with tabbed override editors for all resource types.

Purpose: Core override editing UX — users edit instance-specific configuration with template values shown as context.
Output: Instance detail page with 7 override editor tabs, each with save/reset functionality.
</objective>

<execution_context>
@/home/priz/.claude/get-shit-done/workflows/execute-plan.md
@/home/priz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-service-instances/03-CONTEXT.md
@.planning/phases/03-service-instances/03-RESEARCH.md
@.planning/phases/03-service-instances/03-02-SUMMARY.md
@.planning/phases/03-service-instances/03-03-SUMMARY.md

@dashboard/src/routes/stacks/$name.tsx
@dashboard/src/routes/services/$name.tsx
@dashboard/src/components/services/editable-ports.tsx
@dashboard/src/components/services/editable-env-vars.tsx
@dashboard/src/components/services/editable-healthcheck.tsx
@dashboard/src/components/services/code-editor.tsx
@dashboard/src/lib/instance-queries.ts
@dashboard/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instance detail page with tabbed layout</name>
  <files>dashboard/src/routes/stacks/$name.instances.$instance.tsx</files>
  <action>
Create instance detail page at route /stacks/{name}/instances/{instance}.

Use TanStack Router file-based routing: `$name.instances.$instance.tsx` under routes/stacks/.

Layout:
1. **Breadcrumb**: Stacks > {stack-name} > {instance-name} (per CONTEXT.md)
2. **Header**: Instance name (h1), template name (muted), container name (monospace), enabled status dot
3. **Action buttons in header**: Enable/Disable toggle, Duplicate, Rename, Delete (all open dialogs — can reuse patterns from stack dialogs or create simple inline ones)
4. **Tabs** (use Radix Tabs matching existing service detail pattern):
   - Info (default) — instance metadata: name, description (editable), template info, container name, created/updated timestamps
   - Ports — override-ports component
   - Volumes — override-volumes component
   - Environment — override-env-vars component
   - Labels — override-labels component
   - Domains — override-domains component
   - Healthcheck — override-healthcheck component
   - Config Files — override-config-files component
   - Effective Config — placeholder tab (built in Plan 05)
   - **Dependencies NOT included** — dependencies are template-only per CONTEXT.md decision ("Dependency overrides NOT user-editable"). Dependency wiring is Phase 8.

Each tab lazy-loads its data. The useInstance hook provides override data.

Also need the template service data for showing placeholders. Fetch template via GET /api/v1/services/{template_name} — add a `useService` query if not already available, or use existing service query hooks.

**Key UX patterns (from CONTEXT.md):**
- Template value shown as muted/placeholder text alongside editable override field
- Overridden fields have subtle colored left border (use border-l-2 border-blue-500)
- "Add" button per section for new overrides
- Explicit save button (changes staged locally until save)
- Per-field reset icon (X button that removes override)
- "Reset all overrides" option in section header

Use controlled form state: load override data into local state, user edits, save button calls mutation.
  </action>
  <verify>`npm run build:strict` passes. Page renders at /stacks/{name}/instances/{instance} with all tabs visible.</verify>
  <done>Instance detail page renders with tab navigation, header actions, and breadcrumb</done>
</task>

<task type="auto">
  <name>Task 2: Override editor components for all 7 types</name>
  <files>
    dashboard/src/components/instances/override-ports.tsx
    dashboard/src/components/instances/override-volumes.tsx
    dashboard/src/components/instances/override-env-vars.tsx
    dashboard/src/components/instances/override-labels.tsx
    dashboard/src/components/instances/override-domains.tsx
    dashboard/src/components/instances/override-healthcheck.tsx
    dashboard/src/components/instances/override-config-files.tsx
  </files>
  <action>
Create 7 override editor components. Each follows the same pattern:

**Props:** `{ instance: InstanceDetail, templateData: Service }` (Service from existing types)

**Common pattern for list-type overrides (ports, volumes, env_vars, labels, domains):**
1. Show template values as read-only rows with muted styling (gray text, no edit controls)
2. Show override values as editable rows with colored left border (border-l-2 border-blue-500)
3. "Add Override" button at bottom to add new row
4. Each override row has: editable fields + reset (X) icon to remove that override
5. "Save" button (disabled when no changes) calls the PUT mutation
6. "Reset All" in section header clears all overrides (confirm first)
7. Use local state (useState) for editing. Initialize from instance override data. Dirty tracking by comparing to initial data.
8. Loading state on save button, error display inline

**Specific per-component:**

**override-ports.tsx:**
- Template ports: show host_port:container_port/protocol as read-only
- Override form: host_ip input (default 0.0.0.0), host_port (number), container_port (number), protocol dropdown (tcp/udp)
- Show full host:container mapping (per CONTEXT.md)

**override-volumes.tsx:**
- Fields: volume_type dropdown (bind/volume/tmpfs), source, target, read_only checkbox, is_external checkbox
- Support both bind mounts and named volumes (per CONTEXT.md)

**override-env-vars.tsx:**
- Template env vars shown as muted placeholder rows
- Override rows: key input, value input (password-style if is_secret), is_secret toggle
- For keys that exist in template: show template value as placeholder in the value field
- For new keys: just key + value inputs

**override-labels.tsx:**
- devarch.* labels shown as read-only with lock icon (system-managed per CONTEXT.md)
- Custom labels editable
- Reject new labels with "devarch." prefix (client-side validation + server rejects too)

**override-domains.tsx:**
- Simple domain list: domain input + optional proxy_port
- Template domains as read-only reference

**override-healthcheck.tsx:**
- Individual field editing (per CONTEXT.md): test command (textarea), interval, timeout, retries, start_period (all number inputs with labels)
- Show template healthcheck values as placeholders in each field
- Single save for all fields (one PUT)
- Full replacement semantics

**override-config-files.tsx:**
- List of config files (template + override)
- Click file to open CodeMirror editor (reuse existing code-editor.tsx component)
- Template file content shown as read-only reference
- Override content in editable CodeMirror
- Each file has save/reset independently
- "Add Config File" button for new files not in template
  </action>
  <verify>`npm run build:strict` passes. Each component renders correctly within its tab on the instance detail page.</verify>
  <done>All 7 override types have working editor components with template placeholders, save/reset, and dirty tracking</done>
</task>

</tasks>

<verification>
- Instance detail page loads at correct route
- All tabs render their override editors
- Template values appear as muted placeholders
- Override values have colored left border indicator
- Save button persists changes to API
- Reset removes overrides
- devarch.* labels are read-only
- CodeMirror works for config file editing
- TypeScript compilation clean
</verification>

<success_criteria>
- INST-02 through INST-09 (all override types) achievable via dashboard
- INST-05 (edit overrides after creation) working
- INST-12 (dashboard UI) — override editing complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-service-instances/03-04-SUMMARY.md`
</output>
